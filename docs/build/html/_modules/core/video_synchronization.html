<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.video_synchronization &mdash; let_it_be_3D test documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            let_it_be_3D
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">core</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">let_it_be_3D</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">core.video_synchronization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for core.video_synchronization</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">ffmpeg</span>
<span class="kn">import</span> <span class="nn">imageio</span> <span class="k">as</span> <span class="nn">iio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">.marker_detection</span> <span class="kn">import</span> <span class="n">DeeplabcutInterface</span><span class="p">,</span> <span class="n">ManualAnnotation</span>
<span class="kn">from</span> <span class="nn">.plotting</span> <span class="kn">import</span> <span class="n">AlignmentPlotIndividual</span><span class="p">,</span> <span class="n">LEDMarkerPlot</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Coordinates</span><span class="p">,</span> <span class="n">convert_to_path</span>
<span class="kn">from</span> <span class="nn">.video_metadata</span> <span class="kn">import</span> <span class="n">VideoMetadata</span>


<div class="viewcode-block" id="TimeseriesTemplate"><a class="viewcode-back" href="../../core.html#core.video_synchronization.TimeseriesTemplate">[docs]</a><span class="k">class</span> <span class="nc">TimeseriesTemplate</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">template_attribute_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="TimeseriesTemplate.adjust_template_timeseries_to_fps"><a class="viewcode-back" href="../../core.html#core.video_synchronization.TimeseriesTemplate.adjust_template_timeseries_to_fps">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_template_timeseries_to_fps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust template to framerate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fps: int</span>
<span class="sd">            The framerate, to which the template will be adjusted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fps_adjusted_templates: list of tuple[np.ndarray, int]</span>
<span class="sd">            List of all possible timeseries that could be observed, given the</span>
<span class="sd">            framerate and the resolution of the template (1 ms) as tuple of</span>
<span class="sd">            template as np.ndarray and offset in ms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_timeseries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_attribute_string</span><span class="p">)</span>
        <span class="n">fps_adjusted_templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">framerate</span> <span class="o">=</span> <span class="n">fps</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">max_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">template_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">framerate</span><span class="p">)</span>
        <span class="n">max_offset</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">//</span> <span class="n">fps</span>
        <span class="k">for</span> <span class="n">offset_in_ms</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_offset</span><span class="p">):</span>
            <span class="n">image_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="mi">0</span> <span class="o">+</span> <span class="n">offset_in_ms</span><span class="p">,</span>
                <span class="n">template_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset_in_ms</span><span class="p">,</span>
                <span class="n">max_frames</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">while</span> <span class="n">image_timestamps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">template_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">image_timestamps</span> <span class="o">=</span> <span class="n">image_timestamps</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">adjusted_template</span> <span class="o">=</span> <span class="n">template_timeseries</span><span class="p">[</span><span class="n">image_timestamps</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">fps_adjusted_templates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">adjusted_template</span><span class="p">,</span> <span class="n">offset_in_ms</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fps_adjusted_templates</span></div></div>


<div class="viewcode-block" id="MotifTemplate"><a class="viewcode-back" href="../../core.html#core.video_synchronization.MotifTemplate">[docs]</a><span class="k">class</span> <span class="nc">MotifTemplate</span><span class="p">(</span><span class="n">TimeseriesTemplate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to store single motif.</span>

<span class="sd">    Attributes</span>
<span class="sd">    __________</span>
<span class="sd">    led_on_time_in_ms: int</span>
<span class="sd">        Duration of one on-peak.</span>
<span class="sd">    on_off_period_length_in_ms: int</span>
<span class="sd">        Period between two on-peaks.</span>
<span class="sd">    motif_duration_in_ms: int</span>
<span class="sd">        Total duration of the motif.</span>
<span class="sd">    template_timeseries: np.ndarray</span>
<span class="sd">        Array of binary 0 / 1 values representing a single motif with a</span>
<span class="sd">        resolution of 1 ms.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    adjust_template_timeseries_to_fps</span>
<span class="sd">        Adjust template to framerate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">template_attribute_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;template_timeseries&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">led_on_time_in_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">on_off_period_length_in_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">motif_duration_in_ms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for class MotifTemplate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        led_on_time_in_ms: int</span>
<span class="sd">            Duration of one on-peak.</span>
<span class="sd">        on_off_period_length_in_ms: int</span>
<span class="sd">            Period between two on-peaks.</span>
<span class="sd">        motif_duration_in_ms: int</span>
<span class="sd">            Total duration of the motif.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_on_time_in_ms</span> <span class="o">=</span> <span class="n">led_on_time_in_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_off_period_length_in_ms</span> <span class="o">=</span> <span class="n">on_off_period_length_in_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motif_duration_in_ms</span> <span class="o">=</span> <span class="n">motif_duration_in_ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_template_timeseries</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_template_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">led_on_off_period</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_off_period_length_in_ms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">led_on_off_period</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_on_time_in_ms</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">full_repetitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motif_duration_in_ms</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_off_period_length_in_ms</span>
        <span class="n">remaining_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">motif_duration_in_ms</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_off_period_length_in_ms</span>
        <span class="n">motif_template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">led_on_off_period</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">full_repetitions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">adjusted_end_index</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_off_period_length_in_ms</span> <span class="o">*</span> <span class="n">full_repetitions</span> <span class="o">+</span> <span class="n">remaining_ms</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">motif_template</span><span class="p">[:</span><span class="n">adjusted_end_index</span><span class="p">]</span></div>


<div class="viewcode-block" id="MultiMotifTemplate"><a class="viewcode-back" href="../../core.html#core.video_synchronization.MultiMotifTemplate">[docs]</a><span class="k">class</span> <span class="nc">MultiMotifTemplate</span><span class="p">(</span><span class="n">TimeseriesTemplate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to combine single motives and store the resulting multi_motif.</span>

<span class="sd">    Attributes</span>
<span class="sd">    __________</span>
<span class="sd">    multi_motif_template: np.ndarray</span>
<span class="sd">        Array of binary 0 / 1 values representing a multi_motif_template with a</span>
<span class="sd">        resolution of 1 ms.</span>
<span class="sd">    motif_templates: list of MotifTemplates</span>
<span class="sd">        List of single motifs.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    add_motif_template(motif_template)</span>
<span class="sd">        Append a motif to the already existing multi_motif.</span>
<span class="sd">    adjust_template_timeseries_to_fps</span>
<span class="sd">        Adjust template to framerate.</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    construct_template_motif</span>
<span class="sd">        Construct template from dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">template_attribute_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;multi_motif_template&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for class MultiMotifTemplate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_motif_template</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motif_templates</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="MultiMotifTemplate.add_motif_template"><a class="viewcode-back" href="../../core.html#core.video_synchronization.MultiMotifTemplate.add_motif_template">[docs]</a>    <span class="k">def</span> <span class="nf">add_motif_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motif_template</span><span class="p">:</span> <span class="n">MotifTemplate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a motif to the already existing multi_motif.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motif_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">motif_template</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_motif_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_template</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_update_session_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">individual_motif_template_timeseries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">elem</span><span class="o">.</span><span class="n">template_timeseries</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">motif_templates</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">individual_motif_template_timeseries</span><span class="p">)</span></div>


<div class="viewcode-block" id="construct_template_motif"><a class="viewcode-back" href="../../core.html#core.video_synchronization.construct_template_motif">[docs]</a><span class="k">def</span> <span class="nf">construct_template_motif</span><span class="p">(</span>
        <span class="n">blinking_patterns_metadata</span><span class="p">:</span> <span class="n">Dict</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">MotifTemplate</span><span class="p">,</span> <span class="n">MultiMotifTemplate</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct template from dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    blinking_patterns_metadata:</span>
<span class="sd">        Dictionaries with patterns as values, that specify arguments for</span>
<span class="sd">        MotifTemplate as key-value pairs: &quot;led_on_time_in_ms&quot;,</span>
<span class="sd">        &quot;on_off_period_length_in_ms&quot;, &quot;motif_duration_in_ms&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    template_motif: MotifTemplate or MultiMotifTemplate</span>
<span class="sd">        The constructed template.</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    MultiMotifTemplate</span>
<span class="sd">        Class to combine single motives and store the resulting multi_motif.</span>
<span class="sd">    MotifTemplate</span>
<span class="sd">        Class to store single motif.</span>

<span class="sd">    Examples</span>
<span class="sd">    ________</span>
<span class="sd">    &gt;&gt;&gt; from core.video_synchronization import construct_template_motif</span>
<span class="sd">    &gt;&gt;&gt; led_pattern = \</span>
<span class="sd">    ... {0: {&#39;led_on_time_in_ms&#39;: 50,</span>
<span class="sd">    ... &#39;on_off_period_length_in_ms&#39;: 100,</span>
<span class="sd">    ... &#39;motif_duration_in_ms&#39;: 3000},</span>
<span class="sd">    ... 1: {&#39;led_on_time_in_ms&#39;: 50,</span>
<span class="sd">    ... &#39;on_off_period_length_in_ms&#39;: 1000,</span>
<span class="sd">    ... &#39;motif_duration_in_ms&#39;: 2000}}</span>
<span class="sd">    &gt;&gt;&gt; template_motif = construct_template_motif(led_pattern)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">motif_templates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pattern_idx</span><span class="p">,</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">blinking_patterns_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">motif_templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">MotifTemplate</span><span class="p">(</span>
                <span class="n">led_on_time_in_ms</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;led_on_time_in_ms&quot;</span><span class="p">],</span>
                <span class="n">on_off_period_length_in_ms</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;on_off_period_length_in_ms&quot;</span><span class="p">],</span>
                <span class="n">motif_duration_in_ms</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;motif_duration_in_ms&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_templates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Could not construct a blinking pattern template. Please validate your config files!&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">motif_templates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">template_motif</span> <span class="o">=</span> <span class="n">motif_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">template_motif</span> <span class="o">=</span> <span class="n">MultiMotifTemplate</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">motif_templates</span><span class="p">:</span>
            <span class="n">template_motif</span><span class="o">.</span><span class="n">add_motif_template</span><span class="p">(</span><span class="n">motif_template</span><span class="o">=</span><span class="n">template</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template_motif</span></div>


<span class="k">def</span> <span class="nf">_find_closest_timestamp_index</span><span class="p">(</span>
        <span class="n">original_timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">original_timestamps</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_find_frame_idxs_closest_to_target_timestamps</span><span class="p">(</span>
        <span class="n">target_timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">original_timestamps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">frame_indices_closest_to_target_timestamps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">timestamp</span> <span class="ow">in</span> <span class="n">target_timestamps</span><span class="p">:</span>
        <span class="n">closest_frame_index</span> <span class="o">=</span> <span class="n">_find_closest_timestamp_index</span><span class="p">(</span>
            <span class="n">original_timestamps</span><span class="o">=</span><span class="n">original_timestamps</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span>
        <span class="p">)</span>
        <span class="n">frame_indices_closest_to_target_timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">closest_frame_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame_indices_closest_to_target_timestamps</span>


<span class="k">def</span> <span class="nf">_get_ms_interval_per_frame</span><span class="p">(</span><span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">fps</span>


<span class="k">def</span> <span class="nf">_adjust_frame_idxs_for_synchronization_shift</span><span class="p">(</span>
        <span class="n">unadjusted_frame_idxs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">adjusted_frame_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">unadjusted_frame_idxs</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_idx</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">adjusted_frame_idxs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_compute_fps_adjusted_frame_count</span><span class="p">(</span>
        <span class="n">original_n_frames</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">original_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">target_ms_per_frame</span> <span class="o">=</span> <span class="n">_get_ms_interval_per_frame</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">)</span>
    <span class="n">original_ms_per_frame</span> <span class="o">=</span> <span class="n">_get_ms_interval_per_frame</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">original_fps</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">original_n_frames</span> <span class="o">*</span> <span class="n">original_ms_per_frame</span><span class="p">)</span> <span class="o">/</span> <span class="n">target_ms_per_frame</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_compute_timestamps</span><span class="p">(</span>
        <span class="n">n_frames</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">ms_per_frame</span> <span class="o">=</span> <span class="n">_get_ms_interval_per_frame</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_frames</span> <span class="o">*</span> <span class="n">ms_per_frame</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">ms_per_frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timestamps</span> <span class="o">+</span> <span class="n">offset</span>


<span class="k">def</span> <span class="nf">_znorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_adjust_start_idx_and_offset</span><span class="p">(</span>
        <span class="n">start_frame_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">n_frames_to_add</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">fps</span><span class="p">)</span>
    <span class="n">adjusted_start_frame_idx</span> <span class="o">=</span> <span class="n">start_frame_idx</span> <span class="o">+</span> <span class="n">n_frames_to_add</span>
    <span class="n">original_ms_per_frame</span> <span class="o">=</span> <span class="n">_get_ms_interval_per_frame</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
    <span class="n">remaining_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">n_frames_to_add</span> <span class="o">*</span> <span class="n">original_ms_per_frame</span>
    <span class="k">return</span> <span class="n">adjusted_start_frame_idx</span><span class="p">,</span> <span class="n">remaining_offset</span>


<span class="k">def</span> <span class="nf">_get_start_end_indices_from_center_coord_and_length</span><span class="p">(</span>
        <span class="n">center_px</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="n">center_px</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">end_index</span> <span class="o">=</span> <span class="n">center_px</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span>


<span class="k">def</span> <span class="nf">_load_synchro</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Coordinates</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">synchro_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">synchro_object</span><span class="p">[</span><span class="s2">&quot;led_center_coordinates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">synchro_object</span><span class="p">[</span><span class="s2">&quot;led_center_coordinates&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> \
        <span class="n">synchro_object</span><span class="p">[</span><span class="s2">&quot;offset_adjusted_start_idx&quot;</span><span class="p">],</span> <span class="n">synchro_object</span><span class="p">[</span><span class="s2">&quot;remaining_offset&quot;</span><span class="p">],</span> <span class="n">synchro_object</span><span class="p">[</span>
        <span class="s2">&quot;alignment_error&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kahan</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kahan</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kahan</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">kahan</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">kahan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">_fft_zdist</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copyright 2020 NVIDIA Corporation</span>

<span class="sd">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">    you may not use this file except in compliance with the License.</span>
<span class="sd">    You may obtain a copy of the License at http: // www.apache.org / licenses / LICENSE - 2.0</span>

<span class="sd">    This function and the local functions called in this function where taken from</span>
<span class="sd">    https://github.com/NVIDIA/rapidAligner.git.</span>
<span class="sd">    Changes were made in a way, that this function is able to use numpy instead of cupy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alignment</span><span class="p">,</span> <span class="n">kahan</span> <span class="o">=</span> <span class="mi">10_000</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="n">_znorm</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">alignment</span> <span class="o">*</span> <span class="n">alignment</span>
    <span class="n">is_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">is_</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_cumsum</span><span class="p">(</span><span class="n">is_</span><span class="p">,</span> <span class="n">kahan</span><span class="p">),</span> <span class="n">_cumsum</span><span class="p">(</span><span class="n">is_</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kahan</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">+</span><span class="n">m</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">+</span><span class="n">m</span><span class="p">:]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="n">m</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">m</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">m</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">e</span><span class="p">[:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">irfft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">is_</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># toggle output</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># toggle output</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">r</span><span class="p">[:</span> <span class="o">-</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">z</span><span class="p">),</span> <span class="n">m</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_run_cpu_aligner</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_fft_zdist</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_split_into_ram_digestable_parts</span><span class="p">(</span><span class="n">idxs_of_frames_to_sample</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_ram_digestible_frames</span><span class="p">:</span> <span class="nb">int</span>
                                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">frame_idxs_to_sample</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs_of_frames_to_sample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_ram_digestible_frames</span><span class="p">:</span>
        <span class="n">frame_idxs_to_sample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">idxs_of_frames_to_sample</span><span class="p">[:</span><span class="n">max_ram_digestible_frames</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">idxs_of_frames_to_sample</span> <span class="o">=</span> <span class="n">idxs_of_frames_to_sample</span><span class="p">[</span>
                                   <span class="n">max_ram_digestible_frames</span><span class="p">:</span>
                                   <span class="p">]</span>
    <span class="n">frame_idxs_to_sample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs_of_frames_to_sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frame_idxs_to_sample</span>


<span class="k">def</span> <span class="nf">_delete_individual_video_parts</span><span class="p">(</span><span class="n">filepaths_of_video_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span>
                                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths_of_video_parts</span><span class="p">:</span>
        <span class="n">filepath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>


<div class="viewcode-block" id="Synchronizer"><a class="viewcode-back" href="../../core.html#core.video_synchronization.Synchronizer">[docs]</a><span class="k">class</span> <span class="nc">Synchronizer</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to synchronize videos.</span>

<span class="sd">    Run alignment between constructed MotifTemplate and detected led blinking</span>
<span class="sd">    pattern.</span>
<span class="sd">    Select frames based on timestemps to match framerate, potentially</span>
<span class="sd">    interpolate and add frames.</span>
<span class="sd">    Start marker detection or write video and save the adjusted files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    __________</span>
<span class="sd">    video_metadata: VideoMetadata</span>
<span class="sd">        Metadata from video.</span>
<span class="sd">    output_directory: Path or str</span>
<span class="sd">        Directory, in which the files created during the synchronisation are</span>
<span class="sd">        saved.</span>
<span class="sd">    synchro_metadata: Dict</span>
<span class="sd">        Metadata for synchronisation containing SYNCHRO_METADATA_KEYS.</span>

<span class="sd">    Attributes</span>
<span class="sd">    __________</span>
<span class="sd">    video_metadata: VideoMetadata</span>
<span class="sd">        Metadata from video.</span>
<span class="sd">    use_rapid_aligner: bool</span>
<span class="sd">        If True, synchro pattern alignment will be based on GPU, if False, on CPU.</span>
<span class="sd">    rapid_aligner_path: Path</span>
<span class="sd">        Path to locally installed clone of the rapid_aligner package to use GPU</span>
<span class="sd">        for pattern synchronisation.</span>
<span class="sd">    use_gpu: str</span>
<span class="sd">        Whether to restrict the usage of GPU for DLC analyses.</span>
<span class="sd">    led_box_size: int</span>
<span class="sd">        Pixel range around predicted synchro marker position to calculate mean pixel</span>
<span class="sd">        intensity for blinking pattern from.</span>
<span class="sd">    output_directory: Path or str</span>
<span class="sd">        Directory, in which the files created during the synchronisation are</span>
<span class="sd">        saved.</span>
<span class="sd">    synchro_metadata: Dict</span>
<span class="sd">        Metadata for synchronisation containing SYNCHRO_METADATA_KEYS.</span>
<span class="sd">    led_timeseries_for_cross_video_validation: np.ndarray</span>
<span class="sd">        Mean pixel intensity at predicted synchro marker position adjusted to</span>
<span class="sd">        target fps.</span>
<span class="sd">    led_detection: LEDMarkerPlot</span>
<span class="sd">        Plot to verify correct prediction of LED marker.</span>
<span class="sd">    led_timeseries: np.ndarray</span>
<span class="sd">        Extracted mean pixel intensity at predicted synchro marker position.</span>
<span class="sd">    template_blinking_motif: MotifTemplate or MultiMotifTemplate</span>
<span class="sd">        Constructed template from blinking pattern metadata.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    run_synchronization(synchronize_only, overwrite_DLC_analysis_and_synchro, verbose)</span>
<span class="sd">        Run alignment between template and detected led blinking pattern.</span>
<span class="sd">        Select frames to adjust framerate. Start marker detection or write video.</span>

<span class="sd">    Examples</span>
<span class="sd">    ________</span>
<span class="sd">    &gt;&gt;&gt; from core.video_synchronization import RecordingVideoDownSynchronizer</span>
<span class="sd">    &gt;&gt;&gt; from core.video_metadata import VideoMetadata</span>
<span class="sd">    &gt;&gt;&gt; from core.utils import read_config, SYNCHRO_METADATA_KEYS</span>
<span class="sd">    &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">    &gt;&gt;&gt; project_config = read_config(&quot;test_data/project_config.yaml&quot;)</span>
<span class="sd">    &gt;&gt;&gt; video_filepath = Path(&quot;test_data/Server_structure/VGlut2-flp/September2022/206_F2-63/220922_OTE/220922_206_F2-63_OTE_Side2.mp4&quot;)</span>
<span class="sd">    &gt;&gt;&gt; recording_config_dict = read_config(&quot;test_data/Server_structure/Calibrations/220922/recording_config_220922.yaml&quot;)</span>
<span class="sd">    &gt;&gt;&gt; synchro_metadata = {key:project_config[key] for key in SYNCHRO_METADATA_KEYS})</span>
<span class="sd">    &gt;&gt;&gt; video = VideoMetadata(video_filepath=video_filepath, recording_config_dict=recording_config_dict,</span>
<span class="sd">        ... project_config_dict=project_config, tag = &quot;recording&quot;)</span>
<span class="sd">    &gt;&gt;&gt; synchronizer_object = RecordingVideoDownSynchronizer(video_metadata=video,</span>
<span class="sd">        ... output_directory=video_filepath.parent, synchro_metadata=synchro_metadata)</span>
<span class="sd">    &gt;&gt;&gt; marker_detection_filepath, _ = synchronizer_object.run_synchronization()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target_fps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]]:</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_create_h5_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_rawfps_unsynchronized&quot;</span><span class="p">,</span> <span class="n">filtered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">video_metadata</span><span class="p">:</span> <span class="n">VideoMetadata</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">synchro_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct all necessary attributes for class Synchronizer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        video_metadata: VideoMetadata</span>
<span class="sd">            Metadata from video.</span>
<span class="sd">        output_directory: Path or str</span>
<span class="sd">            Directory, in which the files created during the synchronisation are</span>
<span class="sd">            saved.</span>
<span class="sd">        synchro_metadata: Dict</span>
<span class="sd">            Metadata for synchronisation containing SYNCHRO_METADATA_KEYS.</span>

<span class="sd">        See Also</span>
<span class="sd">        ________</span>
<span class="sd">        core.utils.SYNCHRO_METADATA_KEYS</span>
<span class="sd">        core.utils.KEYS_TO_CHECK_PROJECT</span>

<span class="sd">        Notes</span>
<span class="sd">        _____</span>
<span class="sd">        The keys in synchro_metadata are from project config. For explanation</span>
<span class="sd">        of these attributes, we refer to KEYS_TO_CHECK_PROJECT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_detection</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_blinking_motif</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span> <span class="o">=</span> <span class="n">video_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_rapid_aligner</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;rapid_aligner_path&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rapid_aligner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rapid_aligner_path</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;rapid_aligner_path&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;use_gpu&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span> <span class="o">=</span> <span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;led_box_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span> <span class="o">=</span> <span class="n">synchro_metadata</span>

<div class="viewcode-block" id="Synchronizer.run_synchronization"><a class="viewcode-back" href="../../core.html#core.video_synchronization.Synchronizer.run_synchronization">[docs]</a>    <span class="k">def</span> <span class="nf">run_synchronization</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run alignment between template and detected led blinking pattern.</span>
<span class="sd">        Select frames to adjust framerate. Start marker detection or write video.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        synchronize_only: bool, default False</span>
<span class="sd">            To be used by calibration videos only. If True, then only</span>
<span class="sd">            synchronized videos are created and no marker detection is run.</span>
<span class="sd">        overwrite_DLC_analysis_and_synchro: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing DLC files and</span>
<span class="sd">            synchronisations will be overwritten during analysis.</span>
<span class="sd">        verbose: bool, default True</span>
<span class="sd">            If True (default), then the number of synchronized frames is printed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        marker_detection_filepath: Path, optional</span>
<span class="sd">            The path to the synchronised marker prediction file.</span>
<span class="sd">        synchronized_video_filepath: Path, optional</span>
<span class="sd">            The path to the synchronised video file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_blinking_motif</span> <span class="o">=</span> <span class="n">construct_template_motif</span><span class="p">(</span>
            <span class="n">blinking_patterns_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_pattern</span><span class="p">)</span>

        <span class="n">preexisting_output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_preexisting_output_filepath</span><span class="p">()</span>
        <span class="n">synchro_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_synchro_filepath</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_DLC_analysis_and_synchro</span> <span class="ow">and</span> <span class="n">preexisting_output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">marker_detection_filepath</span><span class="p">,</span> <span class="n">synchronized_video_filepath</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">preexisting_output_file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
                <span class="n">marker_detection_filepath</span><span class="p">,</span> <span class="n">synchronized_video_filepath</span> <span class="o">=</span> <span class="n">preexisting_output_file</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">preexisting_output_file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.mp4&quot;</span><span class="p">:</span>
                <span class="n">synchronized_video_filepath</span><span class="p">,</span> <span class="n">marker_detection_filepath</span> <span class="o">=</span> <span class="n">preexisting_output_file</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_DLC_analysis_and_synchro</span> <span class="ow">and</span> <span class="n">synchro_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">led_center_coordinates</span><span class="p">,</span> <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span> <span class="o">=</span> <span class="n">_load_synchro</span><span class="p">(</span>
                    <span class="n">filepath</span><span class="o">=</span><span class="n">synchro_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">led_center_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_led_center_coordinates</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_led_pixel_intensities</span><span class="p">(</span><span class="n">led_center_coords</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">)</span>
                <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_match_of_template</span><span class="p">(</span>
                    <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_blinking_motif</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;start_pattern_match_ms&quot;</span><span class="p">],</span>
                    <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;end_pattern_match_ms&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">alignment_error</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_error_threshold&quot;</span><span class="p">]:</span>
                    <span class="n">led_center_coordinates</span><span class="p">,</span> <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_synchro_fails</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_plot_led_marker</span><span class="p">(</span><span class="n">led_center_coordinates</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_led_timeseries_for_cross_validation</span><span class="p">(</span><span class="n">start_idx</span><span class="o">=</span><span class="n">offset_adjusted_start_idx</span><span class="p">,</span>
                                                                     <span class="n">offset</span><span class="o">=</span><span class="n">remaining_offset</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_synchro</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">synchro_file</span><span class="p">,</span>
                                   <span class="n">led_center_coordinates</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">,</span>
                                   <span class="n">offset_adjusted_start_idx</span><span class="o">=</span><span class="n">offset_adjusted_start_idx</span><span class="p">,</span>
                                   <span class="n">remaining_offset</span><span class="o">=</span><span class="n">remaining_offset</span><span class="p">,</span>
                                   <span class="n">alignment_error</span><span class="o">=</span><span class="n">alignment_error</span><span class="p">)</span>

            <span class="n">marker_detection_filepath</span><span class="p">,</span> <span class="n">synchronized_video_filepath</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span><span class="n">target_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span>
                                                                          <span class="n">start_idx</span><span class="o">=</span><span class="n">offset_adjusted_start_idx</span><span class="p">,</span>
                                                                          <span class="n">offset</span><span class="o">=</span><span class="n">remaining_offset</span><span class="p">,</span>
                                                                          <span class="n">synchronize_only</span><span class="o">=</span><span class="n">synchronize_only</span><span class="p">,</span>
                                                                          <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum_synchronized</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">duration_synchronized</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_framenumber_of_synchronized_files</span><span class="p">(</span><span class="n">synchronize_only</span><span class="o">=</span><span class="n">synchronize_only</span><span class="p">,</span>
                                                        <span class="n">marker_detection_filepath</span><span class="o">=</span><span class="n">marker_detection_filepath</span><span class="p">,</span>
                                                        <span class="n">synchronized_video_filepath</span><span class="o">=</span><span class="n">synchronized_video_filepath</span><span class="p">,</span>
                                                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">marker_detection_filepath</span><span class="p">,</span> <span class="n">synchronized_video_filepath</span></div>

    <span class="k">def</span> <span class="nf">_get_preexisting_output_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">CharucoVideoSynchronizer</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_video_filepath</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">RecordingVideoUpSynchronizer</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_upsampled</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">fps_synchronized&quot;</span><span class="p">,</span>
                                                   <span class="n">filtered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s1">&#39;use_2D_filter&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">RecordingVideoDownSynchronizer</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_downsampled</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">fps_synchronized&quot;</span><span class="p">,</span>
                                                   <span class="n">filtered</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s1">&#39;use_2D_filter&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">output_file</span>

    <span class="k">def</span> <span class="nf">_get_synchro_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;synchro_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">.p&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_led_center_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Coordinates</span><span class="p">:</span>
        <span class="n">temp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">)</span>
        <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">temp_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_type</span> <span class="o">==</span> <span class="s2">&quot;DLC&quot;</span><span class="p">:</span>
            <span class="n">video_filepath_out</span> <span class="o">=</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_LED_detection_samples.mp4&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
                <span class="n">dlc_filepath_out</span> <span class="o">=</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_LED_detection_predictions.h5&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dlc_filepath_out</span> <span class="o">=</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">.h5&quot;</span>
                <span class="p">)</span>

            <span class="n">num_frames_to_pick</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s1">&#39;num_frames_to_pick&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">num_frames_to_pick</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum</span><span class="p">:</span>
                <span class="n">num_frames_to_pick</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">sample_frame_idxs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum</span><span class="p">),</span> <span class="n">num_frames_to_pick</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">selected_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sample_frame_idxs</span><span class="p">:</span>
                <span class="n">selected_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">video_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">selected_frames</span><span class="p">)</span>
            <span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">video_filepath_out</span><span class="p">),</span> <span class="n">video_array</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">macro_block_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">dlc_interface</span> <span class="o">=</span> <span class="n">DeeplabcutInterface</span><span class="p">(</span>
                <span class="n">object_to_analyse</span><span class="o">=</span><span class="n">video_filepath_out</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="n">temp_folder</span><span class="p">,</span>
                <span class="n">marker_detection_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_filepath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dlc_filepath_out</span> <span class="o">=</span> <span class="n">dlc_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">dlc_filepath_out</span><span class="p">,</span> <span class="n">filtering</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">use_gpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;.pickle&quot;</span><span class="p">:</span>
                    <span class="n">dlc_created_picklefile</span> <span class="o">=</span> <span class="n">file</span>
                    <span class="n">dlc_created_picklefile</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">dlc_filepath_out</span><span class="p">)</span>
            <span class="n">x_key</span><span class="p">,</span> <span class="n">y_key</span><span class="p">,</span> <span class="n">likelihood_key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">],</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">],</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;likelihood&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">likelihood_key</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="n">x_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">likelihood_key</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span> <span class="n">y_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">video_filepath_out</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">dlc_filepath_out</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_type</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="n">config_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_filepath</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
                <span class="n">manual_filepath_out</span> <span class="o">=</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_LED_detection_predictions.h5&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">manual_filepath_out</span> <span class="o">=</span> <span class="n">temp_folder</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">.h5&quot;</span>
                <span class="p">)</span>

            <span class="n">manual_interface</span> <span class="o">=</span> <span class="n">ManualAnnotation</span><span class="p">(</span>
                <span class="n">object_to_analyse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">marker_detection_directory</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">manual_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">manual_filepath_out</span><span class="p">,</span>
                                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]],</span> <span class="n">only_first_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">manual_filepath_out</span><span class="p">)</span>
            <span class="n">x_key</span><span class="p">,</span> <span class="n">y_key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">],</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">manual_filepath_out</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For LED extraction only DLC and manual are supported!&quot;</span><span class="p">)</span>
        <span class="n">temp_folder</span><span class="o">.</span><span class="n">rmdir</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Coordinates</span><span class="p">(</span><span class="n">y_or_row</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">x_or_column</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_led_pixel_intensities</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">led_center_coords</span><span class="p">:</span> <span class="n">Coordinates</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">box_row_indices</span> <span class="o">=</span> <span class="n">_get_start_end_indices_from_center_coord_and_length</span><span class="p">(</span>
            <span class="n">center_px</span><span class="o">=</span><span class="n">led_center_coords</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span>
        <span class="p">)</span>
        <span class="n">box_col_indices</span> <span class="o">=</span> <span class="n">_get_start_end_indices_from_center_coord_and_length</span><span class="p">(</span>
            <span class="n">center_px</span><span class="o">=</span><span class="n">led_center_coords</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span>
        <span class="p">)</span>
        <span class="n">mean_pixel_intensities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_mean_pixel_intensities</span><span class="p">(</span>
            <span class="n">box_row_indices</span><span class="o">=</span><span class="n">box_row_indices</span><span class="p">,</span> <span class="n">box_col_indices</span><span class="o">=</span><span class="n">box_col_indices</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mean_pixel_intensities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_mean_pixel_intensities</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">box_row_indices</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">box_col_indices</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">mean_pixel_intensities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">box_mean_intensity</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span>
                                 <span class="n">box_row_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">box_row_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">box_col_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">box_col_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">mean_pixel_intensities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_mean_intensity</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mean_pixel_intensities</span>

    <span class="k">def</span> <span class="nf">_find_best_match_of_template</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">template</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MotifTemplate</span><span class="p">,</span> <span class="n">MultiMotifTemplate</span><span class="p">],</span>
            <span class="n">start_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">end_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">adjusted_motif_timeseries</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">adjust_template_timeseries_to_fps</span><span class="p">(</span>
            <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span>
        <span class="p">)</span>
        <span class="n">start_frame_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_index_closest_to_time</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">start_time</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">end_frame_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_index_closest_to_time</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">end_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">end_frame_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># if the given end_time is larger than the length of the corresponding video,</span>
            <span class="c1"># its set to the last frame of the video</span>
        <span class="p">(</span>
            <span class="n">best_match_start_frame_idx</span><span class="p">,</span>
            <span class="n">best_match_offset</span><span class="p">,</span>
            <span class="n">alignment_error</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_start_index_and_offset_of_best_match</span><span class="p">(</span>
            <span class="n">adjusted_templates</span><span class="o">=</span><span class="n">adjusted_motif_timeseries</span><span class="p">,</span>
            <span class="n">start_frame_idx</span><span class="o">=</span><span class="n">start_frame_idx</span><span class="p">,</span>
            <span class="n">end_frame_idx</span><span class="o">=</span><span class="n">end_frame_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span> <span class="o">=</span> <span class="n">_adjust_start_idx_and_offset</span><span class="p">(</span>
            <span class="n">start_frame_idx</span><span class="o">=</span><span class="n">best_match_start_frame_idx</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">best_match_offset</span><span class="p">,</span>
            <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_downsampled</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_upsampled</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
            <span class="n">filename_individual</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">&quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;_charuco_synchronization_individual</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename_individual</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">&quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">&quot;</span> \
                                  <span class="sa">f</span><span class="s2">&quot;_synchronization_individual</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronization_individual</span> <span class="o">=</span> <span class="n">AlignmentPlotIndividual</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="n">adjusted_motif_timeseries</span><span class="p">[</span><span class="n">best_match_offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">led_timeseries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="p">[</span><span class="n">best_match_start_frame_idx</span><span class="p">:],</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename_individual</span><span class="p">,</span>
            <span class="n">cam_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="n">led_box_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span><span class="p">,</span>
            <span class="n">alignment_error</span><span class="o">=</span><span class="n">alignment_error</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronization_individual</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span>

    <span class="k">def</span> <span class="nf">_get_frame_index_closest_to_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">time_error_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The specified time: </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2"> is invalid! Both times have to be an integer &quot;</span>
            <span class="s2">&quot;larger than -1, where -1 represents the very last timestamp in the video &quot;</span>
            <span class="s2">&quot;and every other integer (e.g.: 1000) the time in ms. Please be aware, that &quot;</span>
            <span class="s1">&#39;&quot;start_time&quot; has to be larger than &quot;end_time&quot; (with end_time == -1 as only &#39;</span>
            <span class="s2">&quot;exception) and must be smaller or equal to the total video recording time.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">time_error_message</span><span class="p">)</span>
            <span class="n">framerate</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span>
            <span class="n">closest_frame_idx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span> <span class="o">/</span> <span class="n">framerate</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">closest_frame_idx</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">time_error_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">closest_frame_idx</span>

    <span class="k">def</span> <span class="nf">_get_start_index_and_offset_of_best_match</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">adjusted_templates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
            <span class="n">start_frame_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">end_frame_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">lowest_sum_of_squared_error_per_template</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">template_timeseries</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">adjusted_templates</span><span class="p">:</span>
            <span class="n">alignment_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_alignment</span><span class="p">(</span>
                <span class="n">query</span><span class="o">=</span><span class="n">template_timeseries</span><span class="p">,</span>
                <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="p">[</span><span class="n">start_frame_idx</span><span class="p">:</span><span class="n">end_frame_idx</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">lowest_sum_of_squared_error_per_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alignment_results</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">lowest_sum_of_squared_error_per_template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="n">lowest_sum_of_squared_error_per_template</span>
        <span class="p">)</span>
        <span class="n">best_matching_template_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">lowest_sum_of_squared_error_per_template</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">best_alignment_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_alignment</span><span class="p">(</span>
            <span class="n">query</span><span class="o">=</span><span class="n">adjusted_templates</span><span class="p">[</span><span class="n">best_matching_template_index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">subject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="p">[</span><span class="n">start_frame_idx</span><span class="p">:</span><span class="n">end_frame_idx</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">start_index</span> <span class="o">=</span> <span class="n">best_alignment_results</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">best_matching_template_index</span><span class="p">,</span> <span class="n">best_alignment_results</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_run_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rapid_aligner</span><span class="p">:</span>
            <span class="n">alignment_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_rapid_aligner</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alignment_results</span> <span class="o">=</span> <span class="n">_run_cpu_aligner</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alignment_results</span>

    <span class="k">def</span> <span class="nf">_run_rapid_aligner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">subject</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rapid_aligner_path</span><span class="p">))</span>
        <span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>
        <span class="kn">import</span> <span class="nn">rapidAligner</span> <span class="k">as</span> <span class="nn">ra</span>

        <span class="n">subject_timeseries_gpu</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
        <span class="n">query_timeseries_gpu</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">alignment_results</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">ED</span><span class="o">.</span><span class="n">zdist</span><span class="p">(</span>
            <span class="n">query_timeseries_gpu</span><span class="p">,</span> <span class="n">subject_timeseries_gpu</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;fft&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">alignment_results</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_adjust_led_timeseries_for_cross_validation</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">adjusted_led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="p">:</span>
            <span class="n">adjusted_led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample_led_timeseries</span><span class="p">(</span>
                <span class="n">timeseries</span><span class="o">=</span><span class="n">adjusted_led_timeseries</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjusted_led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upsample_led_timeseries</span><span class="p">(</span>
                <span class="n">timeseries</span><span class="o">=</span><span class="n">adjusted_led_timeseries</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">adjusted_led_timeseries</span>

    <span class="k">def</span> <span class="nf">_downsample_led_timeseries</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">n_frames_after_downsampling</span> <span class="o">=</span> <span class="n">_compute_fps_adjusted_frame_count</span><span class="p">(</span>
            <span class="n">original_n_frames</span><span class="o">=</span><span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">original_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">original_timestamps</span> <span class="o">=</span> <span class="n">_compute_timestamps</span><span class="p">(</span>
            <span class="n">n_frames</span><span class="o">=</span><span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
        <span class="p">)</span>
        <span class="n">target_timestamps</span> <span class="o">=</span> <span class="n">_compute_timestamps</span><span class="p">(</span>
            <span class="n">n_frames</span><span class="o">=</span><span class="n">n_frames_after_downsampling</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span>
        <span class="p">)</span>
        <span class="n">frame_idxs_best_matching_timestamps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_find_frame_idxs_closest_to_target_timestamps</span><span class="p">(</span>
                <span class="n">target_timestamps</span><span class="o">=</span><span class="n">target_timestamps</span><span class="p">,</span>
                <span class="n">original_timestamps</span><span class="o">=</span><span class="n">original_timestamps</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">frame_idxs_best_matching_timestamps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_upsample_led_timeseries</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">len_frame_in_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">len_targetframe_in_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">index_in_ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">len_frame_in_ms</span><span class="p">,</span> <span class="n">len_frame_in_ms</span>
        <span class="p">)</span>
        <span class="n">new_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">len_frame_in_ms</span><span class="p">,</span> <span class="n">len_targetframe_in_ms</span>
        <span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">index_in_ms</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">)</span>
        <span class="n">upsampled_timeseries</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">upsampled_timeseries</span>

    <span class="k">def</span> <span class="nf">_handle_synchro_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Coordinates</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Synchronisation failed. Using method &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s1">&#39;handle_synchro_fails&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> now instead!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;handle_synchro_fails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;repeat&quot;</span><span class="p">:</span>
            <span class="n">led_center_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_led_center_coordinates</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_led_pixel_intensities</span><span class="p">(</span><span class="n">led_center_coords</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">)</span>
            <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_match_of_template</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_blinking_motif</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;start_pattern_match_ms&quot;</span><span class="p">],</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;end_pattern_match_ms&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;handle_synchro_fails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">alignment_error</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">led_center_coordinates</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">default_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;default_offset_ms&quot;</span><span class="p">]</span>
            <span class="n">offset_in_framenum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="o">*</span><span class="n">default_offset</span><span class="o">/</span><span class="mi">1000</span>
            <span class="n">not_frame_matching_offset</span> <span class="o">=</span> <span class="n">offset_in_framenum</span> <span class="o">%</span> <span class="mi">1</span>
            <span class="n">remaining_offset</span> <span class="o">=</span> <span class="n">not_frame_matching_offset</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span>
            <span class="n">offset_adjusted_start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset_in_framenum</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;handle_synchro_fails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_type</span> <span class="o">=</span> <span class="s2">&quot;manual&quot;</span>
            <span class="n">led_center_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_led_center_coordinates</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">led_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_led_pixel_intensities</span><span class="p">(</span><span class="n">led_center_coords</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">)</span>
            <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_match_of_template</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_blinking_motif</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;start_pattern_match_ms&quot;</span><span class="p">],</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;end_pattern_match_ms&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;handle_synchro_fails&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Could not synchronize the video. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Make sure, that you chose the right synchronization pattern, </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;that the LED is visible during the pattern</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;and that you chose a proper alignment threshold!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;project_config key handle_synchro_fails has to be in [&#39;error&#39;, &#39;manual&#39;, &#39;repeat&#39;, &#39;default&#39;]&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">led_center_coordinates</span><span class="p">,</span> <span class="n">offset_adjusted_start_idx</span><span class="p">,</span> <span class="n">remaining_offset</span><span class="p">,</span> <span class="n">alignment_error</span>

    <span class="k">def</span> <span class="nf">_plot_led_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">led_center_coordinates</span><span class="p">:</span> <span class="n">Coordinates</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
            <span class="n">led_plot_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">&quot;</span> \
                                <span class="sa">f</span><span class="s2">&quot;_charuco_LED_marker&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">led_plot_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">&quot;</span> \
                                <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_LED_marker&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_detection</span> <span class="o">=</span> <span class="n">LEDMarkerPlot</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">led_center_coordinates</span><span class="o">=</span><span class="n">led_center_coordinates</span><span class="p">,</span>
            <span class="n">box_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span><span class="p">,</span>
            <span class="n">cam_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">led_plot_filename</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led_detection</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_synchro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">led_center_coordinates</span><span class="p">:</span> <span class="n">Coordinates</span><span class="p">,</span> <span class="n">offset_adjusted_start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                      <span class="n">remaining_offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alignment_error</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">synchro_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;filepath&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">),</span>
                        <span class="s2">&quot;fps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
                        <span class="s2">&quot;led_center_coordinates&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">led_center_coordinates</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">led_center_coordinates</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                        <span class="s2">&quot;offset_adjusted_start_idx&quot;</span><span class="p">:</span> <span class="n">offset_adjusted_start_idx</span><span class="p">,</span>
                        <span class="s2">&quot;remaining_offset&quot;</span><span class="p">:</span> <span class="n">remaining_offset</span><span class="p">,</span>
                        <span class="s2">&quot;alignment_error&quot;</span><span class="p">:</span> <span class="n">alignment_error</span><span class="p">,</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                        <span class="s2">&quot;scorer&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_filepath</span><span class="p">,</span>
                        <span class="s2">&quot;synchro_marker&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;synchro_marker&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;led_box_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">led_box_size</span><span class="p">,</span>
                        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_extraction_type</span><span class="p">,</span>
                        <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">led_pattern</span><span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">synchro_dict</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_framenumber_of_synchronized_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">marker_detection_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                                               <span class="n">synchronized_video_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                                               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">synchronize_only</span><span class="p">:</span>
            <span class="n">framenum_synchronized</span> <span class="o">=</span> <span class="n">iio</span><span class="o">.</span><span class="n">v2</span><span class="o">.</span><span class="n">get_reader</span><span class="p">(</span><span class="n">synchronized_video_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">count_frames</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">framenum_synchronized</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">marker_detection_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">duration_synchronized</span> <span class="o">=</span> <span class="p">(</span><span class="n">framenum_synchronized</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2"> Frames after synchronization: </span><span class="si">{</span><span class="n">framenum_synchronized</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">framenum_synchronized</span><span class="p">,</span> <span class="n">duration_synchronized</span>

    <span class="k">def</span> <span class="nf">_downsample_video</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">overwrite_video</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite_video</span><span class="p">:</span>
            <span class="n">preexisting_filepath_downsampled_video</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_video_filepath</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">preexisting_filepath_downsampled_video</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">preexisting_filepath_downsampled_video</span>
        <span class="n">frame_idxs_to_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_frame_idxs</span><span class="p">(</span><span class="n">start_idx</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">target_fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">)</span>
        <span class="n">sampling_frame_idxs_per_part</span> <span class="o">=</span> <span class="n">_split_into_ram_digestable_parts</span><span class="p">(</span>
            <span class="n">idxs_of_frames_to_sample</span><span class="o">=</span><span class="n">frame_idxs_to_sample</span><span class="p">,</span>
            <span class="n">max_ram_digestible_frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">max_ram_digestible_frames</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_idxs_to_sample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">filepaths_all_video_parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_iterative_writing_of_individual_video_parts</span><span class="p">(</span>
                <span class="n">frame_idxs_to_sample</span><span class="o">=</span><span class="n">sampling_frame_idxs_per_part</span><span class="p">)</span>
            <span class="n">filepath_downsampled_video</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concatenate_individual_video_parts_on_disk</span><span class="p">(</span>
                <span class="n">filepaths_of_video_parts</span><span class="o">=</span><span class="n">filepaths_all_video_parts</span><span class="p">)</span>
            <span class="n">_delete_individual_video_parts</span><span class="p">(</span><span class="n">filepaths_of_video_parts</span><span class="o">=</span><span class="n">filepaths_all_video_parts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_idxs_to_sample</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">filepath_downsampled_video</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_video_to_disk</span><span class="p">(</span><span class="n">idxs_of_frames_to_sample</span><span class="o">=</span><span class="n">frame_idxs_to_sample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                   <span class="n">target_fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Can&#39;t synchronize video. Check, whether the file is broken. Unsynchronized video was returned.&quot;</span><span class="p">)</span>
            <span class="n">filepath_downsampled_video</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span>
        <span class="k">return</span> <span class="n">filepath_downsampled_video</span>

    <span class="k">def</span> <span class="nf">_get_sampling_frame_idxs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">original_n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum</span> <span class="o">-</span> <span class="n">start_idx</span>
        <span class="n">n_frames_after_downsampling</span> <span class="o">=</span> <span class="n">_compute_fps_adjusted_frame_count</span><span class="p">(</span>
            <span class="n">original_n_frames</span><span class="o">=</span><span class="n">original_n_frames</span><span class="p">,</span>
            <span class="n">original_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">original_timestamps</span> <span class="o">=</span> <span class="n">_compute_timestamps</span><span class="p">(</span>
            <span class="n">n_frames</span><span class="o">=</span><span class="n">original_n_frames</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span>
        <span class="p">)</span>
        <span class="n">target_timestamps</span> <span class="o">=</span> <span class="n">_compute_timestamps</span><span class="p">(</span>
            <span class="n">n_frames</span><span class="o">=</span><span class="n">n_frames_after_downsampling</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">target_fps</span>
        <span class="p">)</span>
        <span class="n">frame_idxs_best_matching_timestamps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_find_frame_idxs_closest_to_target_timestamps</span><span class="p">(</span>
                <span class="n">target_timestamps</span><span class="o">=</span><span class="n">target_timestamps</span><span class="p">,</span>
                <span class="n">original_timestamps</span><span class="o">=</span><span class="n">original_timestamps</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sampling_frame_idxs</span> <span class="o">=</span> <span class="n">_adjust_frame_idxs_for_synchronization_shift</span><span class="p">(</span>
            <span class="n">unadjusted_frame_idxs</span><span class="o">=</span><span class="n">frame_idxs_best_matching_timestamps</span><span class="p">,</span>
            <span class="n">start_idx</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sampling_frame_idxs</span>

    <span class="k">def</span> <span class="nf">_initiate_iterative_writing_of_individual_video_parts</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">frame_idxs_to_sample</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">max_cpu_cores_to_pool</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">available_cpus</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">available_cpus</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">max_cpu_cores_to_pool</span><span class="p">:</span>
                <span class="n">num_processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">max_cpu_cores_to_pool</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_processes</span> <span class="o">=</span> <span class="n">available_cpus</span>
            <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">filepaths_to_all_video_parts</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_videoslice_to_disk_for_multiprocessing</span><span class="p">,</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_idxs_to_sample</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">filepaths_to_all_video_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idxs_of_frames_to_sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_idxs_to_sample</span><span class="p">):</span>
                <span class="n">part_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">filepath_video_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_video_to_disk</span><span class="p">(</span>
                    <span class="n">idxs_of_frames_to_sample</span><span class="o">=</span><span class="n">idxs_of_frames_to_sample</span><span class="p">,</span>
                    <span class="n">target_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span>
                    <span class="n">part_id</span><span class="o">=</span><span class="n">part_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">filepaths_to_all_video_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath_video_part</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filepaths_to_all_video_parts</span>

    <span class="k">def</span> <span class="nf">_write_videoslice_to_disk_for_multiprocessing</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">idx_and_idxs_of_frames_to_sample</span><span class="p">:</span> <span class="n">Tuple</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">idxs_of_frames_to_sample</span> <span class="o">=</span> <span class="n">idx_and_idxs_of_frames_to_sample</span>
        <span class="n">part_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">filepath_video_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_video_to_disk</span><span class="p">(</span>
            <span class="n">idxs_of_frames_to_sample</span><span class="o">=</span><span class="n">idxs_of_frames_to_sample</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span>
            <span class="n">part_id</span><span class="o">=</span><span class="n">part_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath_video_part</span>

    <span class="k">def</span> <span class="nf">_write_video_to_disk</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">idxs_of_frames_to_sample</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">part_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">selected_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">idxs_of_frames_to_sample</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_of_frames_to_sample</span><span class="p">:</span>
                <span class="n">selected_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">video_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">selected_frames</span><span class="p">)</span>
        <span class="n">filepath_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_video_filepath</span><span class="p">(</span><span class="n">part_id</span><span class="o">=</span><span class="n">part_id</span><span class="p">)</span>
        <span class="n">iio</span><span class="o">.</span><span class="n">v3</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath_out</span><span class="p">,</span> <span class="n">video_array</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">,</span> <span class="n">macro_block_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronized_object_filepath</span> <span class="o">=</span> <span class="n">filepath_out</span>
        <span class="k">return</span> <span class="n">filepath_out</span>

    <span class="k">def</span> <span class="nf">_construct_video_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">calibration</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;_synchronized_downsampled</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">fps.mp4&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;_synchronized_part_</span><span class="si">{</span><span class="n">part_id</span><span class="si">}</span><span class="s2">.mp4&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">part_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_synchronized_downsampled&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">fps.mp4&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">_synchronized_part_</span><span class="si">{</span><span class="n">part_id</span><span class="si">}</span><span class="s2">.mp4&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath</span>

    <span class="k">def</span> <span class="nf">_concatenate_individual_video_parts_on_disk</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">filepaths_of_video_parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">video_part_streams</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ffmpeg</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span> <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">filepaths_of_video_parts</span>
        <span class="p">]</span>
        <span class="n">filepath_concatenated_video</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_video_filepath</span><span class="p">(</span><span class="n">part_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_part_streams</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">concatenated_video</span> <span class="o">=</span> <span class="n">ffmpeg</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="n">video_part_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">video_part_streams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_part_streams</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">part_stream</span> <span class="ow">in</span> <span class="n">video_part_streams</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">concatenated_video</span> <span class="o">=</span> <span class="n">ffmpeg</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">concatenated_video</span><span class="p">,</span> <span class="n">part_stream</span><span class="p">)</span>
            <span class="n">output_stream</span> <span class="o">=</span> <span class="n">ffmpeg</span><span class="o">.</span><span class="n">output</span><span class="p">(</span>
                <span class="n">concatenated_video</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath_concatenated_video</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_stream</span> <span class="o">=</span> <span class="n">ffmpeg</span><span class="o">.</span><span class="n">output</span><span class="p">(</span>
                <span class="n">video_part_streams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath_concatenated_video</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">output_stream</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">overwrite_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath_concatenated_video</span></div>


<div class="viewcode-block" id="CharucoVideoSynchronizer"><a class="viewcode-back" href="../../core.html#core.video_synchronization.CharucoVideoSynchronizer">[docs]</a><span class="k">class</span> <span class="nc">CharucoVideoSynchronizer</span><span class="p">(</span><span class="n">Synchronizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_create_h5_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_rawfps_unsynchronized&quot;</span><span class="p">,</span> <span class="n">filtered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downsample_video</span><span class="p">(</span>
            <span class="n">start_idx</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span>
            <span class="n">overwrite_video</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RecordingVideoSynchronizer"><a class="viewcode-back" href="../../core.html#core.video_synchronization.RecordingVideoSynchronizer">[docs]</a><span class="k">class</span> <span class="nc">RecordingVideoSynchronizer</span><span class="p">(</span><span class="n">Synchronizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                                             <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]]:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_run_deep_lab_cut_for_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">video_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">overwrite_DLC_analysis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">output_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">config_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_filepath</span>
            <span class="n">dlc_interface</span> <span class="o">=</span> <span class="n">DeeplabcutInterface</span><span class="p">(</span>
                <span class="n">object_to_analyse</span><span class="o">=</span><span class="n">video_filepath</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">marker_detection_directory</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dlc_ending</span> <span class="o">=</span> <span class="n">dlc_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">output_filepath</span><span class="p">,</span> <span class="n">filtering</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_filepath</span>

    <span class="k">def</span> <span class="nf">_run_manual_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">video_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">overwrite_DLC_analysis</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">output_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">config_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_filepath</span>
            <span class="n">manual_interface</span> <span class="o">=</span> <span class="n">ManualAnnotation</span><span class="p">(</span>
                <span class="n">object_to_analyse</span><span class="o">=</span><span class="n">video_filepath</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">marker_detection_directory</span><span class="o">=</span><span class="n">config_filepath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">manual_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">output_filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output_filepath</span>

    <span class="k">def</span> <span class="nf">_create_h5_filepath</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;_rawfps_unsynchronized&quot;</span><span class="p">,</span> <span class="n">filtered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filtered</span><span class="p">:</span>
            <span class="n">h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_filtered.h5&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.h5&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">h5_filepath</span></div>

<div class="viewcode-block" id="RecordingVideoDownSynchronizer"><a class="viewcode-back" href="../../core.html#core.video_synchronization.RecordingVideoDownSynchronizer">[docs]</a><span class="k">class</span> <span class="nc">RecordingVideoDownSynchronizer</span><span class="p">(</span><span class="n">RecordingVideoSynchronizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>

        <span class="n">downsynchronized_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_temp&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">==</span> <span class="s2">&quot;DLC&quot;</span><span class="p">:</span>
            <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_deep_lab_cut_for_marker_detection</span><span class="p">(</span>
                <span class="n">video_filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;use_2D_filter&quot;</span><span class="p">]:</span>
                <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">filtered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_manual_marker_detection</span><span class="p">(</span>
                <span class="n">video_filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For processing only DLC and manual are supported!&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">full_h5_filepath</span><span class="p">)</span>
        <span class="n">frame_idxs_to_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_frame_idxs</span><span class="p">(</span><span class="n">start_idx</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">target_fps</span><span class="o">=</span><span class="n">target_fps</span><span class="p">)</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frame_idxs_to_sample</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">new_df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">downsynchronized_filepath</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">downsynchronized_filepath</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RecordingVideoUpSynchronizer"><a class="viewcode-back" href="../../core.html#core.video_synchronization.RecordingVideoUpSynchronizer">[docs]</a><span class="k">class</span> <span class="nc">RecordingVideoUpSynchronizer</span><span class="p">(</span><span class="n">RecordingVideoSynchronizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_adjust_video_to_target_fps_and_run_marker_detection</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target_fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">synchronize_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>

        <span class="n">upsynchronized_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_temp&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">overwrite_DLC_analysis_and_synchro</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">upsynchronized_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">==</span> <span class="s2">&quot;DLC&quot;</span><span class="p">:</span>
                <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_deep_lab_cut_for_marker_detection</span><span class="p">(</span>
                    <span class="n">video_filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s2">&quot;use_2D_filter&quot;</span><span class="p">]:</span>
                    <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_h5_filepath</span><span class="p">(</span><span class="n">filtered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">processing_type</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
                <span class="n">full_h5_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_manual_marker_detection</span><span class="p">(</span>
                    <span class="n">video_filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">overwrite_DLC_analysis</span><span class="o">=</span><span class="n">overwrite_DLC_analysis_and_synchro</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For processing only DLC and manual are supported!&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">full_h5_filepath</span><span class="p">)</span>
            <span class="n">len_frame_in_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">len_targetframe_in_ms</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">total_offset_in_ms</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">*</span> <span class="n">len_frame_in_ms</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="n">recording_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">len_frame_in_ms</span>
            <span class="n">index_in_ms</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">*</span> <span class="n">len_frame_in_ms</span>
            <span class="n">new_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">total_offset_in_ms</span><span class="p">,</span> <span class="n">recording_length</span><span class="p">,</span> <span class="n">len_targetframe_in_ms</span>
            <span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">index_in_ms</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upsampled</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span>
            <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">upsampled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">new_df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">upsynchronized_filepath</span><span class="p">),</span> <span class="s2">&quot;key&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">upsynchronized_filepath</span><span class="p">,</span> <span class="kc">None</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Konstantin Kobel, Dennis Segebarth, Michael Schellenberger.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>core.triangulation_calibration_module &mdash; let_it_be_3D test documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            let_it_be_3D
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">core</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">let_it_be_3D</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">core.triangulation_calibration_module</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for core.triangulation_calibration_module</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Set</span>

<span class="kn">import</span> <span class="nn">aniposelib</span> <span class="k">as</span> <span class="nn">ap_lib</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="n">VideoClip</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>

<span class="kn">from</span> <span class="nn">.angles_and_distances</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">add_reprojection_errors_of_all_calibration_validation_markers</span><span class="p">,</span>
    <span class="n">set_distances_and_angles_for_evaluation</span><span class="p">,</span>
    <span class="n">load_distances_from_ground_truth</span><span class="p">,</span>
    <span class="n">add_errors_between_computed_and_ground_truth_distances_for_different_references</span><span class="p">,</span>
    <span class="n">add_errors_between_computed_and_ground_truth_angles</span><span class="p">,</span> <span class="n">get_xyz_distance_in_triangulation_space</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.marker_detection</span> <span class="kn">import</span> <span class="n">ManualAnnotation</span><span class="p">,</span> <span class="n">DeeplabcutInterface</span>
<span class="kn">from</span> <span class="nn">.plotting</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AlignmentPlotCrossvalidation</span><span class="p">,</span>
    <span class="n">PredictionsPlot</span><span class="p">,</span>
    <span class="n">CalibrationValidationPlot</span><span class="p">,</span>
    <span class="n">TriangulationVisualization</span><span class="p">,</span>
    <span class="n">RotationVisualization</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">convert_to_path</span><span class="p">,</span>
    <span class="n">create_calibration_key</span><span class="p">,</span>
    <span class="n">read_config</span><span class="p">,</span>
    <span class="n">check_keys</span><span class="p">,</span>
    <span class="n">get_multi_index</span><span class="p">,</span>
    <span class="n">get_3D_df_keys</span><span class="p">,</span>
    <span class="n">get_3D_array</span><span class="p">,</span>
    <span class="n">KEYS_TO_CHECK_PROJECT</span><span class="p">,</span>
    <span class="n">KEYS_TO_CHECK_RECORDING</span><span class="p">,</span>
    <span class="n">KEYS_TO_CHECK_CAMERA_PROJECT</span><span class="p">,</span>
    <span class="n">STANDARD_ATTRIBUTES_TRIANGULATION</span><span class="p">,</span>
    <span class="n">STANDARD_ATTRIBUTES_CALIBRATION</span><span class="p">,</span>
    <span class="n">SYNCHRO_METADATA_KEYS</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.video_interface</span> <span class="kn">import</span> <span class="n">VideoInterface</span>
<span class="kn">from</span> <span class="nn">.video_metadata</span> <span class="kn">import</span> <span class="n">VideoMetadata</span>
<span class="kn">from</span> <span class="nn">.video_synchronization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RecordingVideoDownSynchronizer</span><span class="p">,</span>
    <span class="n">RecordingVideoUpSynchronizer</span><span class="p">,</span>
    <span class="n">CharucoVideoSynchronizer</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_metadata_from_configs</span><span class="p">(</span><span class="n">recording_config_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">project_config_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> \
<span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="n">project_config_dict</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">project_config_filepath</span><span class="p">)</span>
    <span class="n">recording_config_dict</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">recording_config_filepath</span><span class="p">)</span>

    <span class="n">missing_keys_project</span> <span class="o">=</span> <span class="n">check_keys</span><span class="p">(</span>
        <span class="n">dictionary</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">,</span> <span class="n">list_of_keys</span><span class="o">=</span><span class="n">KEYS_TO_CHECK_PROJECT</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_keys_project</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing metadata information in the project_config_file&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">project_config_filepath</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">missing_keys_project</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="n">missing_keys_recording</span> <span class="o">=</span> <span class="n">check_keys</span><span class="p">(</span>
        <span class="n">dictionary</span><span class="o">=</span><span class="n">recording_config_dict</span><span class="p">,</span> <span class="n">list_of_keys</span><span class="o">=</span><span class="n">KEYS_TO_CHECK_RECORDING</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_keys_recording</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing information for </span><span class="si">{</span><span class="n">missing_keys_recording</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;in the config_file </span><span class="si">{</span><span class="n">recording_config_filepath</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">dictionary_key</span> <span class="ow">in</span> <span class="n">KEYS_TO_CHECK_CAMERA_PROJECT</span><span class="p">:</span>
        <span class="n">cameras_with_missing_keys</span> <span class="o">=</span> <span class="n">check_keys</span><span class="p">(</span>
            <span class="n">dictionary</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">[</span><span class="n">dictionary_key</span><span class="p">],</span>
            <span class="n">list_of_keys</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">[</span><span class="s2">&quot;valid_cam_ids&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cameras_with_missing_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing information </span><span class="si">{</span><span class="n">dictionary_key</span><span class="si">}</span><span class="s2"> for cam </span><span class="si">{</span><span class="n">cameras_with_missing_keys</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the config_file </span><span class="si">{</span><span class="n">project_config_filepath</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">recording_config_dict</span><span class="p">,</span> <span class="n">project_config_dict</span>


<span class="k">def</span> <span class="nf">_validate_metadata</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                       <span class="n">attributes_to_check</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> \
        <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
    <span class="n">sets_of_attributes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">attribute_to_check</span> <span class="ow">in</span> <span class="n">attributes_to_check</span><span class="p">:</span>
        <span class="n">set_of_attribute</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">video_metadata</span><span class="p">,</span> <span class="n">attribute_to_check</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">video_metadata</span> <span class="ow">in</span> <span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                               <span class="p">)</span>
        <span class="n">sets_of_attributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">set_of_attribute</span><span class="p">)</span>
    <span class="n">attribute</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">sets_of_attributes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The filenames of the calibration_validation images &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;give different metadata! Reasons could be:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  - image belongs to another calibration</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  - image filename is valid, but wrong</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;You should run the filename_checker before to avoid such Errors!&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">set_of_attribute</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">set_of_attribute</span> <span class="ow">in</span> <span class="n">sets_of_attributes</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_exclude_by_framenum</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VideoMetadata</span><span class="p">],</span> <span class="n">allowed_num_diverging_frames</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="n">synch_framenum_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span>
        <span class="p">[</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum_synchronized</span> <span class="k">for</span> <span class="n">video_metadata</span> <span class="ow">in</span> <span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="n">videos_to_exclude</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">video_metadata</span> <span class="ow">in</span> <span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum_synchronized</span> <span class="o">&lt;</span> <span class="p">(</span>
                <span class="n">synch_framenum_median</span> <span class="o">-</span> <span class="n">allowed_num_diverging_frames</span><span class="p">)</span> <span class="ow">or</span> <span class="n">video_metadata</span><span class="o">.</span><span class="n">framenum_synchronized</span> <span class="o">&gt;</span> <span class="p">(</span>
                <span class="n">synch_framenum_median</span> <span class="o">+</span> <span class="n">allowed_num_diverging_frames</span><span class="p">):</span>
            <span class="n">video_metadata</span><span class="o">.</span><span class="n">exclusion_state</span> <span class="o">=</span> <span class="s2">&quot;exclude&quot;</span>
            <span class="n">videos_to_exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">videos_to_exclude</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">videos_to_exclude</span><span class="si">}</span><span class="s2"> were excluded!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">videos_to_exclude</span>


<span class="k">def</span> <span class="nf">_create_output_directory</span><span class="p">(</span><span class="n">project_config_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">unnamed_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">project_config_filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;unnamed_calibration_&quot;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="mi">20</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="n">unnamed_idx</span><span class="p">:</span>
                <span class="n">unnamed_idx</span> <span class="o">=</span> <span class="n">idx</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">project_config_filepath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;unnamed_calibration_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">unnamed_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_directory</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_directory</span>


<span class="k">def</span> <span class="nf">_check_output_directory</span><span class="p">(</span><span class="n">project_config_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                            <span class="n">output_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">output_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_directory</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">output_directory</span> <span class="o">=</span> <span class="n">_create_output_directory</span><span class="p">(</span>
                <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="n">_create_output_directory</span><span class="p">(</span>
            <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">output_directory</span>


<span class="k">def</span> <span class="nf">_create_video_objects</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">recording_config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">project_config_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">videometadata_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">filetypes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">filename_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
    <span class="n">videofiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">filename_tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="ow">and</span> <span class="s2">&quot;synchronized&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="n">filetypes</span><span class="p">]</span>

    <span class="n">video_interfaces</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">metadata_from_videos</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">videofiles</span><span class="p">:</span>
        <span class="n">video_metadata</span> <span class="o">=</span> <span class="n">VideoMetadata</span><span class="p">(</span>
            <span class="n">video_filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">recording_config_dict</span><span class="o">=</span><span class="n">recording_config_dict</span><span class="p">,</span>
            <span class="n">project_config_dict</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="n">videometadata_tag</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">video_interfaces</span><span class="p">[</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">VideoInterface</span><span class="p">(</span>
            <span class="n">video_metadata</span><span class="o">=</span><span class="n">video_metadata</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">metadata_from_videos</span><span class="p">[</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">video_metadata</span>
    <span class="k">return</span> <span class="n">video_interfaces</span><span class="p">,</span> <span class="n">metadata_from_videos</span>


<span class="k">def</span> <span class="nf">_initialize_camera_group</span><span class="p">(</span><span class="n">camera_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">CameraGroup</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">CameraGroup</span><span class="p">(</span><span class="n">camera_objects</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_missing_marker_ids_to_prediction</span><span class="p">(</span>
        <span class="n">missing_marker_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">framenum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="s2">&quot;zero_likelihood_markers&quot;</span>
    <span class="k">for</span> <span class="n">marker_id</span> <span class="ow">in</span> <span class="n">missing_marker_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">]:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">framenum</span><span class="p">)],</span> <span class="p">(</span><span class="n">scorer</span><span class="p">,</span> <span class="n">marker_id</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">df</span>


<span class="k">def</span> <span class="nf">_find_non_matching_list_elements</span><span class="p">(</span><span class="n">list1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">list2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">marker_id</span> <span class="k">for</span> <span class="n">marker_id</span> <span class="ow">in</span> <span class="n">list1</span> <span class="k">if</span> <span class="n">marker_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_duplicate_elems_in_list</span><span class="p">(</span><span class="n">list1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">individual_elems</span><span class="p">,</span> <span class="n">duplicate_elems</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">individual_elems</span><span class="p">:</span>
            <span class="n">duplicate_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">individual_elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_marker_ids_not_in_ground_truth</span><span class="p">(</span>
        <span class="n">marker_ids_to_remove</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">():</span>
    <span class="n">columns_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">column_name</span> <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                         <span class="n">column_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">marker_ids_to_remove</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">columns_to_remove</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_save_dataframe_as_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">filepath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_best_frame_for_normalisation</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">all_normalization_markers</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CENTER&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;REFERENCE_LENGTH_MARKERS&quot;</span><span class="p">]:</span>
        <span class="n">all_normalization_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;REFERENCE_ROTATION_MARKERS&quot;</span><span class="p">]:</span>
        <span class="n">all_normalization_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
    <span class="n">all_normalization_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_normalization_markers</span><span class="p">)</span>
    <span class="n">normalization_keys_nested</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_3D_df_keys</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">all_normalization_markers</span><span class="p">]</span>
    <span class="n">normalization_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">normalization_keys_nested</span><span class="p">)))</span>
    <span class="n">df_normalization_keys</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">normalization_keys</span><span class="p">]</span>
    <span class="n">valid_frames_for_normalization</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_normalization_keys</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">valid_frames_for_normalization</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid_frames_for_normalization</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not normalize the dataframe!&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Calibration"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Calibration">[docs]</a><span class="k">class</span> <span class="nc">Calibration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class, in which videos are calibrated to each other.</span>

<span class="sd">    Temporal synchronization of the videos can be performed based on a pattern.</span>
<span class="sd">    Spatial calibration is performed using aniposelib (ap_lib) with additional</span>
<span class="sd">    methods to validate the calibration based on known ground_truth.</span>

<span class="sd">    Parameters</span>
<span class="sd">    __________</span>
<span class="sd">    calibration_directory: Path or string</span>
<span class="sd">        Directory, where the calibration videos are stored.</span>
<span class="sd">    project_config_filepath: Path or string</span>
<span class="sd">        Filepath to the project_config .yaml file.</span>
<span class="sd">    recording_config_filepath: Path or string</span>
<span class="sd">        Filepath to the recording_config .yaml file.</span>
<span class="sd">    output_directory: Path or string, optional</span>
<span class="sd">        Directory, in which the files created during the analysis are saved.</span>
<span class="sd">        Per default it will be set the same as the calibration_directory.</span>
<span class="sd">    test_mode: bool, default False</span>
<span class="sd">        If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">        during the analysis.</span>

<span class="sd">    Attributes</span>
<span class="sd">    __________</span>
<span class="sd">    project_config_filepath: Path</span>
<span class="sd">        Filepath to the project_config .yaml file.</span>
<span class="sd">    output_directory: Path</span>
<span class="sd">        Directory, in which the files created during the analysis are saved.</span>
<span class="sd">    camera_group: ap_lib.cameras.CameraGroup</span>
<span class="sd">        Group of ap_lib.cameras.Camera objects.</span>
<span class="sd">    camera_objects:</span>
<span class="sd">        List of ap_lib.cameras.Camera objects.</span>
<span class="sd">    synchronized_charuco_videofiles: {str: Path}</span>
<span class="sd">        Dict of synchronized calibration video per camera.</span>
<span class="sd">    video_interfaces: {str: VideoInterface}</span>
<span class="sd">        Dict of VideoInterface objects for all calibration videos.</span>
<span class="sd">    metadata_from_videos: {str: VideoMetadata}</span>
<span class="sd">        Dict of VideoMetadata objects for all calibration videos.</span>
<span class="sd">    valid_videos: list of str</span>
<span class="sd">        Videos, that were found in the calibration_directory and</span>
<span class="sd">        not excluded due to synchronization issues.</span>
<span class="sd">    cams_to_exclude: list of str</span>
<span class="sd">        Videos, that were excluded due to synchronization issues.</span>
<span class="sd">    recording_date: str</span>
<span class="sd">        Date at which the calibration was done.</span>
<span class="sd">    target_fps: int</span>
<span class="sd">        Fps rate, to which the videos should be synchronized.</span>
<span class="sd">    led_pattern: dict</span>
<span class="sd">        Blinking pattern to use for temporal synchronisation.</span>
<span class="sd">    calibration_index: int</span>
<span class="sd">        Index of a calibration.</span>
<span class="sd">        Together with recording_date, it creates a unique calibration key.</span>
<span class="sd">    calibration_tag: str</span>
<span class="sd">        Filename tag to search for in the files in calibration_directory.</span>
<span class="sd">    reprojerr: float</span>
<span class="sd">        Reprojection error (px) returned by ap_lib calibration.</span>
<span class="sd">    report_filepath: Path</span>
<span class="sd">        Filepath to the report .csv for calibration optimisation.</span>
<span class="sd">    allowed_num_diverging_frames: int</span>
<span class="sd">        Difference of framenumber to the framenumber median of all synchronised videos,</span>
<span class="sd">        that is allowed before a video has to be excluded.</span>
<span class="sd">    synchro_metadata: dict</span>
<span class="sd">        Dictionary used as input for synchronizer objects.</span>
<span class="sd">    synchronization_individuals: list of AlignmentPlotIndividual</span>
<span class="sd">        Container for the AlignmentPlotIndividual objects of each synchronized video.</span>
<span class="sd">    led_detection_individuals: list of LEDMarkerPlot</span>
<span class="sd">        Container for the LEDMarkerPlot objects of each synchronized video.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    run_synchronization(test_mode, verbose)</span>
<span class="sd">        Perform synchronization of all videos to the led_pattern and</span>
<span class="sd">        downsampling to target_fps.</span>
<span class="sd">    run_calibration(use_own_intrinsic_calibration, charuco_calibration_board, iteration, verbose, test_mode)</span>
<span class="sd">        Call ap_lib calibrate function.</span>
<span class="sd">    calibrate_optimal(calibration_validation, max_iters, p_threshold, angle_threshold, verbose, test_mode)</span>
<span class="sd">        Call run_calibration repeatedly and validate the quality of the</span>
<span class="sd">        resulting calibration on calibration_validation images and ground_truth.</span>

<span class="sd">    References</span>
<span class="sd">    __________</span>
<span class="sd">    [1] Karashchuk, P., Rupp, K. L., Dickinson, E. S., et al. (2021).</span>
<span class="sd">    Anipose: A toolkit for robust markerless 3D pose estimation.</span>
<span class="sd">    Cell reports, 36(13), 109730. https://doi.org/10.1016/j.celrep.2021.109730</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    TriangulationRecordings:</span>
<span class="sd">        A class, in which videos are triangulated based on a calibration file.</span>
<span class="sd">    CalibrationValidation:</span>
<span class="sd">        A class, in which images are triangulated based on a calibration file</span>
<span class="sd">        and the triangulated coordinates are validated based on a ground_truth.</span>
<span class="sd">    core.checker_objects.CheckCalibration:</span>
<span class="sd">        A class, that checks the metadata and filenames of videos in a given</span>
<span class="sd">        folder and allows for filename changing via user input.</span>
<span class="sd">    core.meta.MetaInterface.create_calibrations:</span>
<span class="sd">        Create Calibration objects for all calibration_directories added to MetaInterface.</span>
<span class="sd">    core.meta.MetaInterface.synchronize_calibrations:</span>
<span class="sd">        Run the function run_synchronization for all calibration objects added</span>
<span class="sd">        to MetaInterface.</span>
<span class="sd">    core.meta.MetaInterface.calibrate:</span>
<span class="sd">        Run the function run_calibration or calibrate_optimal for all calibration</span>
<span class="sd">        objects added to MetaInterface.</span>

<span class="sd">    Examples</span>
<span class="sd">    ________</span>
<span class="sd">    &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">    &gt;&gt;&gt; from core.triangulation_calibration_module import Calibration</span>
<span class="sd">    &gt;&gt;&gt; rec_config = Path(</span>
<span class="sd">    ... &quot;test_data/Server_structure/Calibrations/220922/recording_config_220922.yaml&quot;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; calibration_object = Calibration(</span>
<span class="sd">    ... calibration_directory=rec_config.parent,</span>
<span class="sd">    ... recording_config_filepath=rec_config,</span>
<span class="sd">    ... project_config_filepath=&quot;test_data/project_config.yaml&quot;,</span>
<span class="sd">    ... output_directory=rec_config.parent,</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; calibration_object.run_synchronization()</span>
<span class="sd">    &gt;&gt;&gt; calibration_object.run_calibration(verbose=2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">calibration_directory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">project_config_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">recording_config_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">output_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct all necessary attributes for the Calibration class.</span>

<span class="sd">        Read the metadata from project-/recording config and from video filenames.</span>
<span class="sd">        Create representations of the videos inside the given calibration_directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calibration_directory: Path or string</span>
<span class="sd">            Directory, where the calibration videos are stored.</span>
<span class="sd">        project_config_filepath: Path or string</span>
<span class="sd">            Filepath to the project_config .yaml file.</span>
<span class="sd">        recording_config_filepath: Path or string</span>
<span class="sd">            Filepath to the recording_config .yaml file.</span>
<span class="sd">        output_directory: Path or string, optional</span>
<span class="sd">            Directory, in which the files created during the analysis are saved.</span>
<span class="sd">            Per default it will be set the same as the calibration_directory.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">STANDARD_ATTRIBUTES_CALIBRATION</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_directory</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">calibration_directory</span><span class="p">)</span>
        <span class="n">project_config_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">project_config_filepath</span><span class="p">)</span>
        <span class="n">recording_config_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">recording_config_filepath</span><span class="p">)</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">_check_output_directory</span><span class="p">(</span><span class="n">output_directory</span><span class="o">=</span><span class="n">output_directory</span><span class="p">,</span>
                                                        <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span><span class="p">)</span>
        <span class="n">recording_config_dict</span><span class="p">,</span> <span class="n">project_config_dict</span> <span class="o">=</span> <span class="n">_get_metadata_from_configs</span><span class="p">(</span>
            <span class="n">recording_config_filepath</span><span class="o">=</span><span class="n">recording_config_filepath</span><span class="p">,</span>
            <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">project_config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SYNCHRO_METADATA_KEYS</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;calibration_tag&quot;</span><span class="p">,</span> <span class="s2">&quot;allowed_num_diverging_frames&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">project_config_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recording_date&quot;</span><span class="p">,</span> <span class="s2">&quot;led_pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;calibration_index&quot;</span><span class="p">,</span> <span class="s2">&quot;target_fps&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">recording_config_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span> <span class="o">=</span> <span class="n">_create_video_objects</span><span class="p">(</span>
            <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_directory</span><span class="p">,</span>
            <span class="n">recording_config_dict</span><span class="o">=</span><span class="n">recording_config_dict</span><span class="p">,</span>
            <span class="n">project_config_dict</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">,</span>
            <span class="n">videometadata_tag</span><span class="o">=</span><span class="s2">&quot;calibration&quot;</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="n">filename_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_tag</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;.AVI&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">,</span> <span class="s2">&quot;.mov&quot;</span><span class="p">,</span> <span class="s2">&quot;.mp4&quot;</span><span class="p">],</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">_validate_metadata</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="p">,</span>
                                                     <span class="n">attributes_to_check</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;recording_date&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="p">[</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span> <span class="k">for</span> <span class="n">video_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="c1"># limits target_fps to fps of the slowest video</span>
        <span class="k">for</span> <span class="n">video_metadata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span>

<div class="viewcode-block" id="Calibration.run_synchronization"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Calibration.run_synchronization">[docs]</a>    <span class="k">def</span> <span class="nf">run_synchronization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform synchronization of all videos to the led_pattern and</span>
<span class="sd">        downsampling to target_fps.</span>

<span class="sd">        Call the synchronizer via VideoInterface and save the</span>
<span class="sd">        synchronized_video_filepaths.</span>
<span class="sd">        Create a plot for crossvalidation of the synchronised LED timeseries.</span>
<span class="sd">        Exclude videos, if there are any duplicates in camera names or</span>
<span class="sd">        diverging framenumbers after synchronization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        verbose: bool, default True</span>
<span class="sd">            If True (default), then Crossvalidation plot and synchronised number</span>
<span class="sd">            of frames for each camera are printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchronized_charuco_videofiles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">camera_objects_unexcluded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">video_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">video_interface</span><span class="o">.</span><span class="n">run_synchronizer</span><span class="p">(</span>
                <span class="n">synchronizer</span><span class="o">=</span><span class="n">CharucoVideoSynchronizer</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">synchronize_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
                <span class="n">synchro_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synchronized_charuco_videofiles</span><span class="p">[</span>
                <span class="n">video_interface</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span>
            <span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">video_interface</span><span class="o">.</span><span class="n">synchronized_video_filepath</span><span class="p">)</span>
            <span class="n">camera_objects_unexcluded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video_interface</span><span class="o">.</span><span class="n">export_for_aniposelib</span><span class="p">())</span>
        <span class="n">camera_objects_unexcluded</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_synchro_crossvalidation</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
        <span class="n">cameras</span> <span class="o">=</span> <span class="p">[</span><span class="n">camera_object</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">camera_object</span> <span class="ow">in</span> <span class="n">camera_objects_unexcluded</span><span class="p">]</span>
        <span class="n">duplicate_cams</span> <span class="o">=</span> <span class="n">_get_duplicate_elems_in_list</span><span class="p">(</span><span class="n">cameras</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicate_cams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You added multiple cameras with the cam_id </span><span class="si">{</span><span class="n">duplicate_cams</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;however, all cam_ids must be unique! Please check for duplicates &quot;</span>
                <span class="s2">&quot;in the calibration directory and rename them!&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span> <span class="o">=</span> <span class="n">_exclude_by_framenum</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="p">,</span>
                                               <span class="n">allowed_num_diverging_frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_num_diverging_frames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_videos</span> <span class="o">=</span> <span class="p">[</span><span class="n">cam</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">camera_objects_unexcluded</span> <span class="k">if</span>
                             <span class="n">cam</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">cam</span> <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">camera_objects_unexcluded</span> <span class="k">if</span> <span class="n">cam</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">synchronized_charuco_videofiles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span> <span class="o">=</span> <span class="n">_initialize_camera_group</span><span class="p">(</span><span class="n">camera_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_objects</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calibration.run_calibration"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Calibration.run_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">run_calibration</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">use_own_intrinsic_calibration</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">charuco_calibration_board</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ap_lib</span><span class="o">.</span><span class="n">boards</span><span class="o">.</span><span class="n">CharucoBoard</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">iteration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call ap_lib calibrate function.</span>

<span class="sd">        Create a filename for the calibration file.</span>
<span class="sd">        Pass videos to ap_lib.cameras.camera_group.calibrate_videos function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_own_intrinsic_calibration: bool, default True</span>
<span class="sd">            If True (default), then the externally created intrinsic calibrations</span>
<span class="sd">            are passed to the calibrate function. Otherwise, the ap_lib built-in</span>
<span class="sd">            intrinsic calibration is used.</span>
<span class="sd">        verbose: int, default 0</span>
<span class="sd">            Show ap_lib output if &gt; 1 or no output if &lt;= 1.</span>
<span class="sd">        charuco_calibration_board: ap_lib.boards.CharucoBoard, optional</span>
<span class="sd">            Specify the board, that was used in the calibration videos.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True, pre-existing files won&#39;t be overwritten during the analysis.</span>
<span class="sd">        iteration: int, optional</span>
<span class="sd">            Variable to be included into the filename to make the</span>
<span class="sd">            filepath of calibration files unique for repeated calibrations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        calibration_filepath: Path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calibration_key</span> <span class="o">=</span> <span class="n">create_calibration_key</span><span class="p">(</span><span class="n">videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_videos</span><span class="p">,</span>
                                                 <span class="n">recording_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="p">,</span>
                                                 <span class="n">calibration_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span><span class="p">,</span>
                                                 <span class="n">iteration</span><span class="o">=</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">calibration_key</span><span class="si">}</span><span class="s2">.toml&quot;</span>

        <span class="n">calibration_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">test_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">test_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">calibration_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">charuco_calibration_board</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">aruco_dict</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">Dictionary_get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">aruco</span><span class="o">.</span><span class="n">DICT_6X6_250</span><span class="p">)</span>
                <span class="n">charuco_calibration_board</span> <span class="o">=</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">boards</span><span class="o">.</span><span class="n">CharucoBoard</span><span class="p">(</span>
                    <span class="mi">7</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">,</span>
                    <span class="n">square_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">marker_length</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">marker_bits</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                    <span class="n">aruco_dict</span><span class="o">=</span><span class="n">aruco_dict</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">sorted_videos</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">synchronized_charuco_videofiles</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">videos</span> <span class="o">=</span> <span class="p">[[</span><span class="n">video</span><span class="p">]</span> <span class="k">for</span> <span class="n">video</span> <span class="ow">in</span> <span class="n">sorted_videos</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reprojerr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">calibrate_videos</span><span class="p">(</span>
                <span class="n">videos</span><span class="o">=</span><span class="n">videos</span><span class="p">,</span>
                <span class="n">board</span><span class="o">=</span><span class="n">charuco_calibration_board</span><span class="p">,</span>
                <span class="n">init_intrinsics</span><span class="o">=</span><span class="ow">not</span> <span class="n">use_own_intrinsic_calibration</span><span class="p">,</span>
                <span class="n">init_extrinsics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_calibration</span><span class="p">(</span><span class="n">calibration_filepath</span><span class="o">=</span><span class="n">calibration_filepath</span><span class="p">,</span>
                                   <span class="n">camera_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reprojerr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">calibration_filepath</span></div>

    <span class="k">def</span> <span class="nf">_save_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                          <span class="n">camera_group</span><span class="p">:</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">CameraGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">calibration_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">calibration_filepath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">camera_group</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">calibration_filepath</span><span class="p">)</span>

<div class="viewcode-block" id="Calibration.calibrate_optimal"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Calibration.calibrate_optimal">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_optimal</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">calibration_validation</span><span class="p">:</span> <span class="s2">&quot;CalibrationValidation&quot;</span><span class="p">,</span>
            <span class="n">max_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">p_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">angle_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call run_calibration repeatedly and validates the quality of the</span>
<span class="sd">        resulting calibration on calibration_validation images and ground_truth.</span>

<span class="sd">        Repeat calibration until a good calibration is reached or max_iters is</span>
<span class="sd">        superceded.</span>
<span class="sd">        Check whether the triangulated data in calibration_validation matches</span>
<span class="sd">        the ground_truth data p_threshold and angle_threshold.</span>
<span class="sd">        Create a report file in which the metadata to the calibration of each</span>
<span class="sd">        iteration is specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calibration_validation: CalibrationValidation</span>
<span class="sd">            Object, containing images, triangulated data and ground_truth</span>
<span class="sd">            information for calibration validation.</span>
<span class="sd">        max_iters: int, default 5</span>
<span class="sd">            Number of iterations allowed to find a good calibration.</span>
<span class="sd">        p_threshold: float, default 0.1</span>
<span class="sd">            Threshold for errors in the triangulated distances compared to</span>
<span class="sd">            ground truth (mean distances in percent).</span>
<span class="sd">        angle_threshold: float, default 5</span>
<span class="sd">            Threshold for errors in the triangulated angles compared to ground</span>
<span class="sd">            truth (mean angles in degrees).</span>
<span class="sd">        verbose: int, default 1</span>
<span class="sd">            Show ap_lib output if &gt; 1,</span>
<span class="sd">            calibration_validation output if &gt; 0</span>
<span class="sd">            or no output if &lt; 1.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be</span>
<span class="sd">            overwritten during the analysis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        calibration_filepath: Path</span>
<span class="sd">            The filepath to the optimal calibration of if no good calibration</span>
<span class="sd">            was reached during iteration, the filepath of the last calibration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">calibration_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">calibration_key</span> <span class="o">=</span> <span class="n">create_calibration_key</span><span class="p">(</span><span class="n">videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_videos</span><span class="p">,</span>
                                                 <span class="n">recording_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="p">,</span>
                                                 <span class="n">calibration_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span><span class="p">)</span>
        <span class="n">good_calibration_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">calibration_key</span><span class="si">}</span><span class="s2">.toml&quot;</span><span class="p">)</span>
        <span class="n">calibration_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">good_calibration_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">test_mode</span><span class="p">:</span>
                <span class="n">calibration_filepath</span> <span class="o">=</span> <span class="n">good_calibration_filepath</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reprojerr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">calibration_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_calibration</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
                                                            <span class="n">iteration</span><span class="o">=</span><span class="n">cal</span><span class="p">)</span>

            <span class="n">calibration_validation</span><span class="o">.</span><span class="n">run_triangulation</span><span class="p">(</span><span class="n">calibration_toml_filepath</span><span class="o">=</span><span class="n">calibration_filepath</span><span class="p">)</span>
            <span class="n">mean_dist_err_percentage</span><span class="p">,</span> <span class="n">mean_angle_err</span><span class="p">,</span> <span class="n">reprojerr_nonan_mean</span> <span class="o">=</span> \
                <span class="n">calibration_validation</span><span class="o">.</span><span class="n">evaluate_triangulation_of_calibration_validation_markers</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">show_3D_plot</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Calibration </span><span class="si">{</span><span class="n">cal</span><span class="si">}</span><span class="se">\n</span><span class="s2"> mean percentage error: </span><span class="si">{</span><span class="n">mean_dist_err_percentage</span><span class="si">}</span><span class="se">\n</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;mean angle error: </span><span class="si">{</span><span class="n">mean_angle_err</span><span class="si">}</span><span class="se">\n</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;ap_lib reprojection error: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reprojerr</span><span class="si">}</span><span class="se">\n</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s1">&#39;Calvin mean reprojection error: </span><span class="si">{</span><span class="n">calibration_validation</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;reproj_nonan&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">calibration_filepath</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;num_cams&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_objects</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;cams_to_exclude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;mean_distance_error_percentage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_dist_err_percentage</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;mean_angle_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_angle_err</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;mean_reprojerror_calvin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reprojerr_nonan_mean</span>
            <span class="n">report</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cal</span><span class="p">,</span> <span class="s2">&quot;ap_lib_reprojerr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprojerr</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mean_dist_err_percentage</span> <span class="o">&lt;</span> <span class="n">p_threshold</span> <span class="ow">and</span> <span class="n">mean_angle_err</span> <span class="o">&lt;</span> <span class="n">angle_threshold</span><span class="p">):</span>
                <span class="n">calibration_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">calibration_filepath</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">good_calibration_filepath</span><span class="p">)</span>
                <span class="n">calibration_filepath</span> <span class="o">=</span> <span class="n">good_calibration_filepath</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Good Calibration reached at iteration </span><span class="si">{</span><span class="n">cal</span><span class="si">}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Named it </span><span class="si">{</span><span class="n">good_calibration_filepath</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_calibration_report.csv&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_filepath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">calibration_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;No optimal calibration found with given thresholds! Returned last executed calibration!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calibration_filepath</span></div>

    <span class="k">def</span> <span class="nf">_plot_synchro_crossvalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span>
            <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">template_blinking_motif</span><span class="o">.</span><span class="n">adjust_template_timeseries_to_fps</span><span class="p">(</span>
            <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">led_timeseries_crossvalidation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">video_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">video_interface</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">led_timeseries_crossvalidation</span><span class="p">[</span>
                    <span class="n">video_interface</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">video_interface</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">led_timeseries_crossvalidation</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s1">_charuco_synchronization_crossvalidation_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s1">fps&#39;</span>
            <span class="n">synchronization_crossvalidation</span> <span class="o">=</span> <span class="n">AlignmentPlotCrossvalidation</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                <span class="n">led_timeseries</span><span class="o">=</span><span class="n">led_timeseries_crossvalidation</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">synchronization_crossvalidation</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="Triangulation"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Triangulation">[docs]</a><span class="k">class</span> <span class="nc">Triangulation</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent class, for triangulation of videos or images.</span>

<span class="sd">    Triangulation is performed using aniposelib (ap_lib).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    project_config_filepath: Path or string</span>
<span class="sd">        Filepath to the project_config .yaml file.</span>
<span class="sd">    directory: Path or string</span>
<span class="sd">        Directory, where the videos or images are stored.</span>
<span class="sd">    recording_config_filepath: Path or string</span>
<span class="sd">        Filepath to the recording_config .yaml file.</span>
<span class="sd">    test_mode: bool, default False</span>
<span class="sd">        If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">        during the analysis.</span>
<span class="sd">    output_directory: Path or string, optional</span>
<span class="sd">        Directory, in which the files created during the analysis are saved.</span>
<span class="sd">        Per default it will be set the same as the directory.</span>

<span class="sd">    Attributes</span>
<span class="sd">    __________</span>
<span class="sd">    project_config_filepath: Path</span>
<span class="sd">        Filepath to the project_config .yaml file.</span>
<span class="sd">    output_directory: Path</span>
<span class="sd">        Directory, in which the files created during the analysis are saved.</span>
<span class="sd">    video_interfaces: {str: VideoInterface}</span>
<span class="sd">        Dict of VideoInterface objects for all videos or images.</span>
<span class="sd">    metadata_from_videos: {str: VideoMetadata}</span>
<span class="sd">        Dict of VideoMetadata objects for all videos or images.</span>
<span class="sd">    triangulation_dlc_cams_filepaths: {str: Path}</span>
<span class="sd">        Containing the filepath to the predictions for each camera.</span>
<span class="sd">    csv_output_filepath: Path</span>
<span class="sd">        Filepath, were the triangulated dataframe should be saved.</span>
<span class="sd">    recording_date: str</span>
<span class="sd">        Date at which the calibration was done based on recording_config and as</span>
<span class="sd">        read from the filenames.</span>
<span class="sd">    calibration_index: int</span>
<span class="sd">        Index of a calibration.</span>
<span class="sd">        Together with recording_date, it creates a unique calibration key.</span>
<span class="sd">    target_fps: int</span>
<span class="sd">        Fps rate, to which the videos should be synchronized.</span>
<span class="sd">    led_pattern: dict</span>
<span class="sd">        Blinking pattern to use for temporal synchronisation.</span>
<span class="sd">    mouse_id: str</span>
<span class="sd">        Only defined in TriangulationRecordings. The mouse_id as read</span>
<span class="sd">        from the filenames.</span>
<span class="sd">    paradigm: str</span>
<span class="sd">        Only defined in TriangulationRecordings. The paradigm as read</span>
<span class="sd">        from the filenames.</span>
<span class="sd">    cams_to_exclude: list of str</span>
<span class="sd">        Videos, that were excluded due to synchronization issues.</span>
<span class="sd">    all_cameras: list of str</span>
<span class="sd">        All camera names, that are stored in the camera_group.</span>
<span class="sd">    self.camera_group: ap_lib.cameras.CameraGroup</span>
<span class="sd">        Group of cameras loaded from calibration_toml_filepath.</span>
<span class="sd">    anipose_io: dict</span>
<span class="sd">        Containing information for ap_lib functions, such as points_flat, p3ds,</span>
<span class="sd">        n_joints, reprojerr, as well as distances and angles to validate</span>
<span class="sd">        calibration in comparison with ground truth.</span>
<span class="sd">    markers: list of str</span>
<span class="sd">        All markers that will be triangulated.</span>
<span class="sd">    normalised_dataframe: bool, default False</span>
<span class="sd">        If True (default False), then the dataframe was normalised based on</span>
<span class="sd">        input from normalisation config.</span>
<span class="sd">    markers_excluded_manually: bool, default False</span>
<span class="sd">        If True (default False), then markers were excluded from predictions</span>
<span class="sd">        based on marker exclusion config.</span>
<span class="sd">    rotated_filepath: Path</span>
<span class="sd">        Filepath, were the rotated triangulated dataframe is saved.</span>
<span class="sd">    video_plotting_config: dict</span>
<span class="sd">        Containing information from video_plotting config to create 3D videos.</span>
<span class="sd">    synchronization_individuals: list of AlignmentPlotIndividual</span>
<span class="sd">        Only defined in TriangulationRecordings. Container for the AlignmentPlotIndividual objects of each synchronized video.</span>
<span class="sd">    led_detection_individuals: list of LEDMarkerPlot</span>
<span class="sd">        Only defined in TriangulationRecordings. Container for the LEDMarkerPlot objects of each synchronized video.</span>
<span class="sd">    synchro_metadata: dict</span>
<span class="sd">        Only used in TriangulationRecordings. Dictionary used as input for synchronizer objects.</span>
<span class="sd">    allowed_num_diverging_frames: int</span>
<span class="sd">        Only used in TriangulationRecordings. Difference of framenumber to the framenumber median of all synchronised videos,</span>
<span class="sd">        that is allowed before a video has to be excluded.</span>
<span class="sd">    ground_truth_config: dict</span>
<span class="sd">        Only defined in CalibrationValidation to compare the triangulated data</span>
<span class="sd">        to ground truth data.</span>
<span class="sd">    calibration_validation_tag: str</span>
<span class="sd">        Only used in CalibrationValidation. Filename tag to search for in the</span>
<span class="sd">        filenames in directory.</span>
<span class="sd">    _allowed_filetypes: list of str</span>
<span class="sd">        Abstract property, specify what file endings to look for in directory.</span>
<span class="sd">    triangulation_visualization: TriangulationVisualization</span>
<span class="sd">        Object to create plots for triangulation video.</span>
<span class="sd">    video_start_s: int</span>
<span class="sd">        The second, in which the triangulation video starts.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    run_triangulation(calibration_toml_filepath, test_mode):</span>
<span class="sd">        Load and validate the calibration, triangulate and create 3D df.</span>
<span class="sd">    exclude_marker(all_markers_to_exclude_config_path, verbose):</span>
<span class="sd">        Exclude markers in prediction based on markers_to_exclude config.</span>
<span class="sd">    _get_dataframe_of_triangulated_points(anipose_io):</span>
<span class="sd">        Combine the triangulated data from anipose_io to a 3D df.</span>

<span class="sd">    References</span>
<span class="sd">    __________</span>
<span class="sd">    [1] Karashchuk, P., Rupp, K. L., Dickinson, E. S., et al. (2021).</span>
<span class="sd">    Anipose: A toolkit for robust markerless 3D pose estimation.</span>
<span class="sd">    Cell reports, 36(13), 109730. https://doi.org/10.1016/j.celrep.2021.109730</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    TriangulationRecordings:</span>
<span class="sd">        Subclass of Triangulation, in which videos are triangulated based on a</span>
<span class="sd">        calibration file.</span>
<span class="sd">    CalibrationValidation:</span>
<span class="sd">        Subclass of Triangulation, in which images are triangulated based on a</span>
<span class="sd">        calibration file and the triangulated coordinates are validated based on</span>
<span class="sd">        a ground_truth.</span>
<span class="sd">    Calibration:</span>
<span class="sd">        A class, in which videos are calibrated to each other.</span>
<span class="sd">    core.meta.MetaInterface.triangulate_recordings:</span>
<span class="sd">        Run the function run_triangulation for all TriangulationRecording</span>
<span class="sd">        objects added to MetaInterface.</span>
<span class="sd">    Calibration.triangulate_optim:</span>
<span class="sd">        Run the function run_triangulation for the CalibrationValidation</span>
<span class="sd">        object passed to triangulate_optim.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_create_csv_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_metadata_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_allowed_filetypes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_videometadata_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">project_config_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">directory</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">recording_config_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                 <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">output_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct all necessary attributes for the Triangulation Class.</span>

<span class="sd">        Read the metadata from project-/recording config and from video filenames.</span>
<span class="sd">        Create csv_output_filepath based on the metadata.</span>
<span class="sd">        Create representations of the videos inside the given directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project_config_filepath: Path or string</span>
<span class="sd">            Filepath to the project_config .yaml file.</span>
<span class="sd">        directory: Path or string</span>
<span class="sd">            Directory, where the videos or images are stored.</span>
<span class="sd">        recording_config_filepath: Path or string</span>
<span class="sd">            Filepath to the recording_config .yaml file.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        output_directory: Path or string, optional</span>
<span class="sd">            Directory, in which the files created during the analysis are saved.</span>
<span class="sd">            Per default it will be set the same as the directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">STANDARD_ATTRIBUTES_TRIANGULATION</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">project_config_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">project_config_filepath</span><span class="p">)</span>
        <span class="n">recording_config_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">recording_config_filepath</span><span class="p">)</span>
        <span class="n">output_directory</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">_check_output_directory</span><span class="p">(</span><span class="n">output_directory</span><span class="o">=</span><span class="n">output_directory</span><span class="p">,</span>
                                                        <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span><span class="p">)</span>
        <span class="n">recording_config_dict</span><span class="p">,</span> <span class="n">project_config_dict</span> <span class="o">=</span> <span class="n">_get_metadata_from_configs</span><span class="p">(</span>
            <span class="n">recording_config_filepath</span><span class="o">=</span><span class="n">recording_config_filepath</span><span class="p">,</span>
            <span class="n">project_config_filepath</span><span class="o">=</span><span class="n">project_config_filepath</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">project_config_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">SYNCHRO_METADATA_KEYS</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;use_gpu&quot;</span><span class="p">,</span> <span class="s2">&quot;calibration_validation_tag&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;score_threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;triangulation_type&quot;</span><span class="p">,</span> <span class="s2">&quot;allowed_num_diverging_frames&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">project_config_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;recording_date&quot;</span><span class="p">,</span> <span class="s2">&quot;led_pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;target_fps&quot;</span><span class="p">,</span> <span class="s2">&quot;calibration_index&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">recording_config_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span> <span class="o">=</span> <span class="n">_create_video_objects</span><span class="p">(</span>
            <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span>
            <span class="n">recording_config_dict</span><span class="o">=</span><span class="n">recording_config_dict</span><span class="p">,</span>
            <span class="n">project_config_dict</span><span class="o">=</span><span class="n">project_config_dict</span><span class="p">,</span>
            <span class="n">videometadata_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_videometadata_tag</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="n">filename_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_validation_tag</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_videometadata_tag</span> <span class="o">==</span> <span class="s2">&quot;calvin&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowed_filetypes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">_validate_metadata</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="p">,</span>
                                      <span class="n">attributes_to_check</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_keys</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Triangulation.run_triangulation"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Triangulation.run_triangulation">[docs]</a>    <span class="k">def</span> <span class="nf">run_triangulation</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">calibration_toml_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and validate the calibration, triangulate and create 3D df.</span>

<span class="sd">        Validate, that the camera names in camera_group match</span>
<span class="sd">        triangulation_dlc_cams_filepaths and drop or add empty files if they don&#39;t.</span>
<span class="sd">        Triangulate using different options as defined in the project_config via</span>
<span class="sd">        ap_lib functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calibration_toml_filepath: Path or str</span>
<span class="sd">            Filepath to the calibration, that should be used for triangulation.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_csv_filepath</span><span class="p">()</span>
        <span class="n">calibration_toml_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">calibration_toml_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_calibration</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">calibration_toml_filepath</span><span class="p">)</span>

        <span class="n">filepath_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">filepath_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_cameras</span> <span class="o">=</span> <span class="p">[</span><span class="n">camera</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">camera</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">cameras</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_cameras</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">missing_cams_in_all_cameras</span> <span class="o">=</span> <span class="n">_find_non_matching_list_elements</span><span class="p">(</span><span class="n">filepath_keys</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">all_cameras</span><span class="p">)</span>
        <span class="n">missing_cams_in_filepath_keys</span> <span class="o">=</span> <span class="n">_find_non_matching_list_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cameras</span><span class="p">,</span> 
                                                                         <span class="n">filepath_keys</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_cams_in_filepath_keys</span><span class="p">:</span>
            <span class="n">min_framenum</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_empty_files</span><span class="p">(</span><span class="n">cams_to_create_empty_files</span><span class="o">=</span><span class="n">missing_cams_in_filepath_keys</span><span class="p">,</span>
                                     <span class="n">framenum</span><span class="o">=</span><span class="n">min_framenum</span><span class="p">,</span>
                                     <span class="n">markers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">missing_cams_in_all_cameras</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_dlc_predictions_for_anipose</span><span class="p">(</span><span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_type</span> <span class="o">==</span> <span class="s2">&quot;triangulate&quot;</span><span class="p">:</span>
            <span class="n">p3ds_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">triangulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points_flat&quot;</span><span class="p">],</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_type</span> <span class="o">==</span> <span class="s2">&quot;triangulate_optim_ransac_False&quot;</span><span class="p">:</span>
            <span class="n">p3ds_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">triangulate_optim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">],</span>
                                                            <span class="n">init_ransac</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">init_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_joints&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_type</span> <span class="o">==</span> <span class="s2">&quot;triangulate_optim_ransac_True&quot;</span><span class="p">:</span>
            <span class="n">p3ds_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">triangulate_optim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">],</span>
                                                            <span class="n">init_ransac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">init_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_joints&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Supported methods for triangulation are triangulate, &quot;</span>
                <span class="s2">&quot;triangulate_optim_ransac_True, triangulate_optim_ransac_False!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;p3ds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p3ds_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_joints&quot;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;reprojerr&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;reproj_nonan&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span>
            <span class="s2">&quot;reprojerr_flat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reprojection_errors</span><span class="p">(</span>
            <span class="n">p3ds_flat</span><span class="o">=</span><span class="n">p3ds_flat</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dataframe_of_triangulated_points</span><span class="p">(</span><span class="n">anipose_io</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">test_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">test_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_output_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">_save_dataframe_as_csv</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_output_filepath</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_temp_files</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_delete_temp_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;_temp&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<div class="viewcode-block" id="Triangulation.exclude_markers"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.Triangulation.exclude_markers">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_markers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_markers_to_exclude_config_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exclude markers in prediction based on markers_to_exclude config.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all_markers_to_exclude_config_path: Path or str</span>
<span class="sd">            Filepath to the config used for exclusion of markers.</span>
<span class="sd">        verbose: bool, default True</span>
<span class="sd">            If True (default), print if exclusion of markers worked without any</span>
<span class="sd">            abnormalities.</span>

<span class="sd">        Notes</span>
<span class="sd">        _____</span>
<span class="sd">        The all_markers_to_exclude_config_path has to be a path to a yaml file</span>
<span class="sd">        representing a dictionary with the camera names as keys and a list of</span>
<span class="sd">        the markers, that should be excluded as value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_markers_to_exclude</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">all_markers_to_exclude_config_path</span><span class="p">)</span>
        <span class="n">missing_cams</span> <span class="o">=</span> <span class="n">check_keys</span><span class="p">(</span><span class="n">all_markers_to_exclude</span><span class="p">,</span>
                                  <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">missing_cams</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Found no markers to exclude for </span><span class="si">{</span><span class="n">missing_cams</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">all_markers_to_exclude_config_path</span><span class="p">)</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cam_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="p">:</span>
            <span class="n">h5_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="p">[</span><span class="n">cam_id</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">h5_file</span><span class="p">)</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">markers_to_exclude_per_cam</span> <span class="o">=</span> <span class="n">all_markers_to_exclude</span><span class="p">[</span><span class="n">cam_id</span><span class="p">]</span>
            <span class="n">existing_markers_to_exclude</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">markers_to_exclude_per_cam</span><span class="p">))</span>
            <span class="n">not_existing_markers</span> <span class="o">=</span> <span class="p">[</span><span class="n">marker</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">markers_to_exclude_per_cam</span> <span class="k">if</span>
                                    <span class="n">marker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">markers</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">not_existing_markers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The following markers were not found in the dataframe, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;but were given as markers to exclude for </span><span class="si">{</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">not_existing_markers</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_markers_to_exclude</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">existing_markers_to_exclude</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;likelihood&quot;</span><span class="p">:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">h5_file</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers_excluded_manually</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_create_empty_files</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cams_to_create_empty_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">framenum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">markers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="n">cams_to_create_empty_files</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating empty .h5 file for </span><span class="si">{</span><span class="n">cam</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="n">h5_output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;empty_temp_</span><span class="si">{</span><span class="n">cam</span><span class="si">}</span><span class="s2">.h5&quot;</span>
            <span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">get_multi_index</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">framenum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">h5_output_filepath</span><span class="p">),</span> <span class="s2">&quot;empty&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_triangulation_marker_ids</span><span class="p">(</span>
                <span class="n">triangulation_markers_df_filepath</span><span class="o">=</span><span class="n">h5_output_filepath</span><span class="p">,</span> <span class="n">framenum</span><span class="o">=</span><span class="n">framenum</span><span class="p">,</span>
                <span class="n">defined_marker_ids</span><span class="o">=</span><span class="n">markers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="p">[</span><span class="n">cam</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5_output_filepath</span>

    <span class="k">def</span> <span class="nf">_validate_triangulation_marker_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangulation_markers_df_filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                                           <span class="n">framenum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">defined_marker_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                           <span class="n">add_missing_marker_ids_with_0_likelihood</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">triangulation_markers_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">triangulation_markers_df_filepath</span><span class="p">)</span>
        <span class="n">prediction_marker_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">([</span><span class="n">marker_id</span> <span class="k">for</span> <span class="n">scorer</span><span class="p">,</span> <span class="n">marker_id</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span>
                 <span class="n">triangulation_markers_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]))</span>
        <span class="n">marker_ids_not_in_ground_truth</span> <span class="o">=</span> <span class="n">_find_non_matching_list_elements</span><span class="p">(</span><span class="n">prediction_marker_ids</span><span class="p">,</span>
                                                                          <span class="n">defined_marker_ids</span><span class="p">)</span>
        <span class="n">marker_ids_not_in_prediction</span> <span class="o">=</span> <span class="n">_find_non_matching_list_elements</span><span class="p">(</span><span class="n">defined_marker_ids</span><span class="p">,</span>
                                                                        <span class="n">prediction_marker_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_missing_marker_ids_with_0_likelihood</span> <span class="o">&amp;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">marker_ids_not_in_prediction</span><span class="p">):</span>
            <span class="n">triangulation_markers_df</span> <span class="o">=</span> <span class="n">_add_missing_marker_ids_to_prediction</span><span class="p">(</span>
                <span class="n">missing_marker_ids</span><span class="o">=</span><span class="n">marker_ids_not_in_prediction</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="n">triangulation_markers_df</span><span class="p">,</span>
                <span class="n">framenum</span><span class="o">=</span><span class="n">framenum</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;The following marker_ids were missing and added to the dataframe with a &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;likelihood of 0: </span><span class="si">{</span><span class="n">marker_ids_not_in_prediction</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">marker_ids_not_in_ground_truth</span><span class="p">:</span>
            <span class="n">triangulation_markers_df</span> <span class="o">=</span> <span class="n">_remove_marker_ids_not_in_ground_truth</span><span class="p">(</span>
                <span class="n">marker_ids_to_remove</span><span class="o">=</span><span class="n">marker_ids_not_in_ground_truth</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="n">triangulation_markers_df</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;The following marker_ids were deleted from the dataframe, since they were &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not present in the ground truth: </span><span class="si">{</span><span class="n">marker_ids_not_in_ground_truth</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">triangulation_markers_df</span><span class="o">.</span><span class="n">to_hdf</span><span class="p">(</span>
            <span class="n">triangulation_markers_df_filepath</span><span class="p">,</span> <span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">CameraGroup</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.toml&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">cameras</span><span class="o">.</span><span class="n">CameraGroup</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The path, given as calibration_toml_filepath</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;does not end with .toml or does not exist!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Make sure, that you enter the correct path!&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_preprocess_dlc_predictions_for_anipose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">anipose_io</span> <span class="o">=</span> <span class="n">ap_lib</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">load_pose2d_fnames</span><span class="p">(</span>
            <span class="n">fname_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_additional_information_and_continue_preprocessing</span><span class="p">(</span><span class="n">anipose_io</span><span class="o">=</span><span class="n">anipose_io</span><span class="p">,</span>
                                                                           <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_additional_information_and_continue_preprocessing</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">anipose_io</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">n_cams</span><span class="p">,</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">],</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_joints&quot;</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">test_mode</span><span class="p">:</span>
            <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span>
            <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">][:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_idx</span> <span class="o">-</span> <span class="n">start_idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&lt;</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s1">&#39;n_points&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s1">&#39;n_points&#39;</span><span class="p">]</span>
            <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">][:,</span> <span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">][</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points_flat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_cams</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores_flat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_cams</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">anipose_io</span>

    <span class="k">def</span> <span class="nf">_get_reprojection_errors</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">p3ds_flat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
        <span class="n">reprojerr_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_group</span><span class="o">.</span><span class="n">reprojection_error</span><span class="p">(</span><span class="n">p3ds_flat</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points_flat&quot;</span><span class="p">],</span>
                                                              <span class="n">mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">reprojerr</span> <span class="o">=</span> <span class="n">reprojerr_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;n_joints&quot;</span><span class="p">])</span>
        <span class="n">reprojerr_nonan</span> <span class="o">=</span> <span class="n">reprojerr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">reprojerr</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">reprojerr</span><span class="p">,</span> <span class="n">reprojerr_nonan</span><span class="p">,</span> <span class="n">reprojerr_flat</span>

    <span class="k">def</span> <span class="nf">_get_dataframe_of_triangulated_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anipose_io</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The following function was taken from</span>
<span class="sd">        https://github.com/lambdaloop/anipose/blob/d20091550dc8b901f460f914544ecfc66c116329/anipose/triangulate.py.</span>
<span class="sd">        Changes were made to match our needs here.</span>

<span class="sd">        BSD 2-Clause License</span>

<span class="sd">        Copyright (c) 2019, Pierre Karashchuk</span>
<span class="sd">        All rights reserved.</span>

<span class="sd">        Redistribution and use in source and binary forms, with or without</span>
<span class="sd">        modification, are permitted provided that the following conditions are met:</span>

<span class="sd">        1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="sd">           list of conditions and the following disclaimer.</span>

<span class="sd">        2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="sd">           this list of conditions and the following disclaimer in the documentation</span>
<span class="sd">           and/or other materials provided with the distribution.</span>

<span class="sd">        THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="sd">        AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="sd">        IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="sd">        DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="sd">        FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="sd">        DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="sd">        SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="sd">        CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="sd">        OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="sd">        OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_points_raw</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span>
        <span class="n">all_scores</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="n">_cams</span><span class="p">,</span> <span class="n">n_frames</span><span class="p">,</span> <span class="n">n_joints</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">all_points_raw</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">good_points</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">all_points_raw</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">num_cams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">good_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">all_points_3d</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s1">&#39;p3ds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_joints</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">all_errors</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s1">&#39;reprojerr_flat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_frames</span><span class="p">,</span> <span class="n">n_joints</span><span class="p">)</span>
        <span class="n">all_scores</span><span class="p">[</span><span class="o">~</span><span class="n">good_points</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">scores_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">scores_3d</span><span class="p">[</span><span class="n">num_cams</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">all_errors</span><span class="p">[</span><span class="n">num_cams</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">num_cams</span><span class="p">[</span><span class="n">num_cams</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">all_points_3d_adj</span> <span class="o">=</span> <span class="n">all_points_3d</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bp_num</span><span class="p">,</span> <span class="n">bp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;bodyparts&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">ax_num</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]):</span>
                <span class="n">df</span><span class="p">[</span><span class="n">bp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_points_3d_adj</span><span class="p">[:,</span> <span class="n">bp_num</span><span class="p">,</span> <span class="n">ax_num</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">bp</span> <span class="o">+</span> <span class="s2">&quot;_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anipose_io</span><span class="p">[</span><span class="s1">&#39;reprojerr&#39;</span><span class="p">][:,</span> <span class="n">bp_num</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">bp</span> <span class="o">+</span> <span class="s2">&quot;_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_3d</span><span class="p">[:,</span> <span class="n">bp_num</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;M_</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;center_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fnum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_frames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="TriangulationRecordings"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.TriangulationRecordings">[docs]</a><span class="k">class</span> <span class="nc">TriangulationRecordings</span><span class="p">(</span><span class="n">Triangulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of Triangulation, in which videos are triangulated based on a</span>
<span class="sd">    calibration file.</span>

<span class="sd">    Temporal synchronization of the videos can be performed based on a pattern.</span>
<span class="sd">    The triangulated dataframe can be normalised (rotated and translated).</span>
<span class="sd">    For visalization, a triangulated video can be created.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    run_synchronization(test_mode, verbose):</span>
<span class="sd">        Perform analysis of all videos using DLC or other methods,</span>
<span class="sd">        synchronization to the led_pattern and downsampling to target_fps.</span>
<span class="sd">    create_triangulated_video(filename, config_path):</span>
<span class="sd">        Create video of the triangulated data.</span>
<span class="sd">    normalize(normalization_config_path, test_mode):</span>
<span class="sd">        Rotate and translate the triangulated dataframe.</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    Triangulation:</span>
<span class="sd">        Parent class, for triangulation of videos or images.</span>
<span class="sd">    core.meta.MetaInterface.create_recordings:</span>
<span class="sd">        Create TriangulationRecording objects for all recording_directories</span>
<span class="sd">        added to MetaInterface.</span>
<span class="sd">    core.meta.MetaInterface.synchronize_recordings:</span>
<span class="sd">        Run the function run_synchronization for all TriangulationRecording</span>
<span class="sd">        objects added to MetaInterface.</span>
<span class="sd">    core.meta.MetaInterface.triangulate_recordings:</span>
<span class="sd">        Run the function run_triangulation for all TriangulationRecording</span>
<span class="sd">        objects added to MetaInterface.</span>
<span class="sd">    core.checker_objects.CheckRecording:</span>
<span class="sd">        A class, that checks the metadata and filenames of videos in a given</span>
<span class="sd">        folder and allows for filename changing via user input.</span>

<span class="sd">    Examples</span>
<span class="sd">    ________</span>
<span class="sd">    &gt;&gt;&gt; from core.triangulation_calibration_module import TriangulationRecordings</span>
<span class="sd">    &gt;&gt;&gt; rec_config = &quot;test_data/Server_structure/Calibrations/220922/recording_config_220922.yaml&quot;</span>
<span class="sd">    &gt;&gt;&gt; directory = &quot;test_data/Server_structure/VGlut2-flp/September2022/206_F2-63/220922_OTE/&quot;</span>
<span class="sd">    &gt;&gt;&gt; triangulation_object = TriangulationRecordings(</span>
<span class="sd">        ... directory=directory,</span>
<span class="sd">        ... recording_config_filepath=rec_config,</span>
<span class="sd">        ... project_config_filepath=&quot;test_data/project_config.yaml&quot;,</span>
<span class="sd">        ... test_mode = False,</span>
<span class="sd">        ... output_directory=directory</span>
<span class="sd">        ... )</span>
<span class="sd">    &gt;&gt;&gt; triangulation_object.run_synchronization()</span>
<span class="sd">    &gt;&gt;&gt; triangulation_object.exclude_markers(</span>
<span class="sd">        ... all_markers_to_exclude_config_path=&quot;test_data/markers_to_exclude_config.yaml&quot;,</span>
<span class="sd">        ... verbose=False,</span>
<span class="sd">        ... )</span>
<span class="sd">    &gt;&gt;&gt; triangulation_object.run_triangulation(</span>
<span class="sd">        ... calibration_toml_filepath=&quot;test_data/Server_structure/Calibrations/220922/220922_0_Bottom_Ground1_Ground2_Side1_Side2_Side3.toml&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &gt;&gt;&gt; normalised_path, normalisation_error = triangulation_object.normalize(</span>
<span class="sd">        ... normalization_config_path=&quot;test_data/normalization_config.yaml&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_metadata_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;recording_date&quot;</span><span class="p">,</span> <span class="s2">&quot;paradigm&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse_id&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_videometadata_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;recording&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_allowed_filetypes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;.AVI&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">,</span> <span class="s2">&quot;.mov&quot;</span><span class="p">,</span> <span class="s2">&quot;.mp4&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="TriangulationRecordings.run_synchronization"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.TriangulationRecordings.run_synchronization">[docs]</a>    <span class="k">def</span> <span class="nf">run_synchronization</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform analysis of all videos using DLC or other methods,</span>
<span class="sd">        synchronization to the led_pattern and downsampling to target_fps.</span>

<span class="sd">        Call the synchronizer via VideoInterface and save the prediction file in</span>
<span class="sd">        triangulation_dlc_cams_filepaths.</span>
<span class="sd">        Create a plot for crossvalidation of the synchronised LED timeseries.</span>
<span class="sd">        Define self.markers as unique markers found in all prediction files.</span>
<span class="sd">        Exclude videos, if there are diverging framenumbers after synchronization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        verbose: bool, default True</span>
<span class="sd">            If True (default), then Crossvalidation plot and synchronised number</span>
<span class="sd">            of frames for each camera are printed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">video_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">video_interface</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">fps</span>
                    <span class="o">&gt;=</span> <span class="n">video_interface</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">target_fps</span>
            <span class="p">):</span>
                <span class="n">synchronizer</span> <span class="o">=</span> <span class="n">RecordingVideoDownSynchronizer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">synchronizer</span> <span class="o">=</span> <span class="n">RecordingVideoUpSynchronizer</span><span class="p">,</span>
            <span class="n">video_interface</span><span class="o">.</span><span class="n">run_synchronizer</span><span class="p">(</span>
                <span class="n">synchronizer</span><span class="o">=</span><span class="n">synchronizer</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">synchronize_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">,</span>
                <span class="n">synchro_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_synchro_crossvalidation</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">video_interface</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="p">[</span>
                <span class="n">video_interface</span>
            <span class="p">]</span><span class="o">.</span><span class="n">export_for_aniposelib</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">video_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span>
        <span class="p">}</span>

        <span class="n">all_markers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">all_markers</span> <span class="o">=</span> <span class="n">all_markers</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_markers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span> <span class="o">=</span> <span class="n">_exclude_by_framenum</span><span class="p">(</span><span class="n">metadata_from_videos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="p">,</span>
                                               <span class="n">allowed_num_diverging_frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_num_diverging_frames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cams_to_exclude</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cam</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_plot_synchro_crossvalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span>
            <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">template_blinking_motif</span><span class="o">.</span><span class="n">adjust_template_timeseries_to_fps</span><span class="p">(</span>
            <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">led_timeseries_crossvalidation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">video_interface</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_interfaces</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">video_interface</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">led_timeseries_crossvalidation</span><span class="p">[</span>
                    <span class="n">video_interface</span><span class="o">.</span><span class="n">video_metadata</span><span class="o">.</span><span class="n">cam_id</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">video_interface</span><span class="o">.</span><span class="n">synchronizer_object</span><span class="o">.</span><span class="n">led_timeseries_for_cross_video_validation</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">led_timeseries_crossvalidation</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s1">_synchronization_crossvalidation_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s1">fps&#39;</span>
            <span class="n">synchronization_crossvalidation</span> <span class="o">=</span> <span class="n">AlignmentPlotCrossvalidation</span><span class="p">(</span>
                <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                <span class="n">led_timeseries</span><span class="o">=</span><span class="n">led_timeseries_crossvalidation</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">synchronization_crossvalidation</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_csv_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">filepath_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="si">}</span><span class="s2">fps&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="si">}</span><span class="s2">p_excludedmarkers</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">markers_excluded_manually</span><span class="si">}</span><span class="s2">_&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;filtered</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">synchro_metadata</span><span class="p">[</span><span class="s1">&#39;use_2D_filter&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;normalised</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">normalised_dataframe</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulation_type</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath_out</span>

<div class="viewcode-block" id="TriangulationRecordings.normalize"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.TriangulationRecordings.normalize">[docs]</a>    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalization_config_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate and translate the triangulated dataframe.</span>

<span class="sd">        Find frame, in which all markers given in the config are defined.</span>
<span class="sd">        Translate all points to center. Convert into cm. Rotate dataframe using</span>
<span class="sd">        scipy.transform.Rotation.align_vectors to align triangulated vectors</span>
<span class="sd">        and ground truth vectors. Create a plot for Visualization of Rotation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        normalization_config_path: Path or str</span>
<span class="sd">            The path to the config used for normalisation.</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.rotated_filepath: Path</span>
<span class="sd">            Filepath, were the rotated triangulated dataframe is saved.</span>
<span class="sd">        rotation_error: flot</span>
<span class="sd">            Error returned by scipy.transform.Rotation.align_vectors, representing</span>
<span class="sd">            whether the alignment worked well.</span>
<span class="sd">        verbose: bool, default False</span>
<span class="sd">            If True (default False), then the rotation visualization plot is shown.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The normalization_config_path is a path to a yaml file, representing a</span>
<span class="sd">        dictionary with the following key-value pairs:</span>
<span class="sd">            CENTER: str</span>
<span class="sd">                The marker, at which to set (0, 0, 0).</span>
<span class="sd">            REFERENCE_LENGTH_CM: int</span>
<span class="sd">                The reference length in cm.</span>
<span class="sd">            REFERENCE_LENGTH_MARKERS: list</span>
<span class="sd">                The two markers for defining the reference length. The distance</span>
<span class="sd">                between those markers in px will be set to ReferenceLengthCm.</span>
<span class="sd">            REFERENCE_ROTATION_COORDS: list of list of int</span>
<span class="sd">                List of reference rotation markers (at least 3), to align the</span>
<span class="sd">                real world space and the triangulated space.</span>
<span class="sd">                Each element is a list of int, defining their x, y and z coordinate.</span>
<span class="sd">            REFERENCE_ROTATION_MARKERS: list of str</span>
<span class="sd">                List of triangulated markers, that should be aligned with</span>
<span class="sd">                ReferenceRotationCoords. Their lengths have to be equal!</span>
<span class="sd">            INVISIBLE_MARKERS: {str: list of int}</span>
<span class="sd">                Keys are &#39;x&#39;, &#39;y&#39; and &#39;z&#39;, values are lists of ints. All lists</span>
<span class="sd">                have to match in length. The length is equal to the number of</span>
<span class="sd">                points to be plotted.</span>
<span class="sd">                Markers to plot in rotation visualization plot invisiblly. Can</span>
<span class="sd">                be used to set the axis aspect equal, since this feature is not</span>
<span class="sd">                established for 3D axes in matplotlib.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalization_config_path</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">normalization_config_path</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">normalization_config_path</span><span class="p">)</span>
        <span class="n">best_frame</span> <span class="o">=</span> <span class="n">_get_best_frame_for_normalisation</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">get_3D_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CENTER&#39;</span><span class="p">],</span> <span class="n">best_frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;_x&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>
            <span class="k">if</span> <span class="s1">&#39;_y&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span>
            <span class="k">if</span> <span class="s1">&#39;_z&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span>

        <span class="n">reference_length_px</span> <span class="o">=</span> <span class="n">get_xyz_distance_in_triangulation_space</span><span class="p">(</span>
            <span class="n">marker_ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;REFERENCE_LENGTH_MARKERS&#39;</span><span class="p">]),</span>
            <span class="n">df_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">best_frame</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">conversionfactor</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;REFERENCE_LENGTH_CM&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">reference_length_px</span>
        <span class="n">bp_keys_unflat</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_3D_df_keys</span><span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span>
                             <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s1">&#39;score&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s2">&quot;M_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s1">&#39;center&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s1">&#39;fn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">bp_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">bp_keys_unflat</span><span class="p">))</span>
        <span class="n">normalised</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">normalised</span><span class="p">[</span><span class="n">bp_keys</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conversionfactor</span>

        <span class="n">reference_rotation_markers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;REFERENCE_ROTATION_MARKERS&#39;</span><span class="p">]:</span>
            <span class="n">reference_rotation_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_3D_array</span><span class="p">(</span><span class="n">normalised</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">best_frame</span><span class="p">))</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">rotation_error</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">align_vectors</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;REFERENCE_ROTATION_COORDS&quot;</span><span class="p">],</span>
                                                        <span class="n">reference_rotation_markers</span><span class="p">)</span>
        <span class="n">rotated</span> <span class="o">=</span> <span class="n">normalised</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bp_keys_unflat</span><span class="p">:</span>
            <span class="n">rot_points</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">normalised</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]]])</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rotated</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">key</span><span class="p">[</span><span class="n">axis</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rot_points</span><span class="p">[:,</span> <span class="n">axis</span><span class="p">]</span>
        <span class="n">rotated_markers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;REFERENCE_ROTATION_MARKERS&#39;</span><span class="p">]:</span>
            <span class="n">rotated_markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_3D_array</span><span class="p">(</span><span class="n">rotated</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">best_frame</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">normalised_dataframe</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotated_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_csv_filepath</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">test_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">test_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotated_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="n">_save_dataframe_as_csv</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_filepath</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">rotated</span><span class="p">)</span>
        <span class="n">rotation_plot_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mouse_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paradigm</span><span class="si">}</span><span class="s2">_rotation_visualization&quot;</span><span class="p">)</span>
        <span class="n">visualization</span> <span class="o">=</span> <span class="n">RotationVisualization</span><span class="p">(</span>
            <span class="n">rotated_markers</span><span class="o">=</span><span class="n">rotated_markers</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">output_filepath</span><span class="o">=</span><span class="n">rotation_plot_filename</span><span class="p">,</span>
            <span class="n">rotation_error</span><span class="o">=</span><span class="n">rotation_error</span>
        <span class="p">)</span>
        <span class="n">visualization</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotated_filepath</span><span class="p">,</span> <span class="n">rotation_error</span></div>

<div class="viewcode-block" id="TriangulationRecordings.create_triangulated_video"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.TriangulationRecordings.create_triangulated_video">[docs]</a>    <span class="k">def</span> <span class="nf">create_triangulated_video</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">config_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
            <span class="n">start_s</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">end_s</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create video of the triangulated data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str</span>
<span class="sd">            The filename, where the video should be saved.</span>
<span class="sd">        config_path: Path or str</span>
<span class="sd">            The path to the config used to create triangulated videos.</span>
<span class="sd">        start_s:</span>
<span class="sd">            The second in the recording to start video creation.</span>
<span class="sd">        end_s: </span>
<span class="sd">            The second in the recording to end video creation.</span>

<span class="sd">        Notes</span>
<span class="sd">        _____</span>
<span class="sd">        The yaml file at config_path has to have the following keys:</span>
<span class="sd">            body_marker_size, body_label_size: int, int</span>
<span class="sd">            body_marker_color, body_label_color: str, str</span>
<span class="sd">                matplotlib color</span>
<span class="sd">            body_marker_alpha, body_label_alpha: float 0 &lt; 1, float 0 &lt; 1</span>
<span class="sd">            markers_to_exclude: list of str</span>
<span class="sd">                Markers that should not be plotted. Recommended is, giving at</span>
<span class="sd">                least &quot;M_&quot;, &quot;center_&quot;, &quot;fnum&quot; and &quot;Unnamed&quot; to it, since those</span>
<span class="sd">                labels are created from aniposelib and can not be plotted.</span>
<span class="sd">            markers_to_connect: list of list of str, optional</span>
<span class="sd">                Each element consists of a list of markers, that will be</span>
<span class="sd">                connected in the video.</span>
<span class="sd">            markers_to_fill: list of dict, optional</span>
<span class="sd">                Each element consists of a dict, that will be filled in the</span>
<span class="sd">                video. The keys of the dict have to be:</span>
<span class="sd">                    markers: list of str</span>
<span class="sd">                        The markers, to create a polygon in between.</span>
<span class="sd">                    color: str</span>
<span class="sd">                        matplotlib color, to fill the polygon.</span>
<span class="sd">                    alpha: float 0 &lt; 1</span>
<span class="sd">            additional_markers_to_plot: list of dict, optional</span>
<span class="sd">                Markers to plot in addition to the triangulated points.</span>
<span class="sd">                The elements of the lists are dictionaries containing the</span>
<span class="sd">                following key-value pairs:</span>
<span class="sd">                    name: str</span>
<span class="sd">                    x, y, z: int, int, int</span>
<span class="sd">                    alpha: float 0 &lt; 1</span>
<span class="sd">                    size: int</span>
<span class="sd">                    color: str</span>
<span class="sd">                        matplotlib color</span>
<span class="sd">                Can be used to set the axis aspect equal, since this feature is</span>
<span class="sd">                not established for 3D axes in matplotlib.</span>
<span class="sd">                All markers can be used to be connected or filled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">video_plotting_config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_visualization</span> <span class="o">=</span> <span class="n">TriangulationVisualization</span><span class="p">(</span><span class="n">df_3D_filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotated_filepath</span><span class="p">,</span>
                                       <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                       <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">video_plotting_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangulated_video_start_s</span> <span class="o">=</span> <span class="n">start_s</span>
        <span class="n">triangulated_video</span> <span class="o">=</span> <span class="n">VideoClip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_triangulated_plots</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">end_s</span> <span class="o">-</span> <span class="n">start_s</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">triangulated_video</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.mp4&quot;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_triangulated_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulated_video_start_s</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_fps</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_visualization</span><span class="o">.</span><span class="n">return_fig</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span></div>


<div class="viewcode-block" id="CalibrationValidation"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.CalibrationValidation">[docs]</a><span class="k">class</span> <span class="nc">CalibrationValidation</span><span class="p">(</span><span class="n">Triangulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of Triangulation, in which images are triangulated based on a</span>
<span class="sd">    calibration file and the triangulated coordinates are validated based on</span>
<span class="sd">    a ground_truth.</span>

<span class="sd">    Methods</span>
<span class="sd">    _______</span>
<span class="sd">    add_ground_truth_config(ground_truth_config_filepath)</span>
<span class="sd">        Read the metadata from ground_truth_config_filepath and create list of</span>
<span class="sd">        markers.</span>
<span class="sd">    get_marker_predictions(test_mode)</span>
<span class="sd">        Run marker detection for all images in metadata_from_videos.</span>
<span class="sd">    evaluate_triangulation_of_calibration_validation_markers(show_3D_plot, verbose)</span>
<span class="sd">        Evaluate the triangulated data and return mean errors.</span>

<span class="sd">    See Also</span>
<span class="sd">    ________</span>
<span class="sd">    Triangulation:</span>
<span class="sd">        Parent class, for triangulation of videos or images.</span>
<span class="sd">    core.meta.MetaInterface.create_calibrations:</span>
<span class="sd">        Create CalibrationValidation objects and run add_ground_truth_config for</span>
<span class="sd">        all calibration_directories added to MetaInterface.</span>
<span class="sd">    core.meta.MetaInterface.synchronize_calibrations:</span>
<span class="sd">        Run get_marker_predictions for all calibration_validation objects added</span>
<span class="sd">        to MetaInterface.</span>
<span class="sd">    core.checker_objects.CheckCalibrationValidation:</span>
<span class="sd">        A class, that checks the metadata and filenames of videos in a given</span>
<span class="sd">        folder and allows for filename changing via user input.</span>
<span class="sd">    Calibration.triangulate_optim:</span>
<span class="sd">        Run the function run_triangulation for the CalibrationValidation</span>
<span class="sd">        object passed to triangulate_optim.</span>

<span class="sd">    Examples</span>
<span class="sd">    ________</span>
<span class="sd">    &gt;&gt;&gt; from core.triangulation_calibration_module import CalibrationValidation</span>
<span class="sd">    &gt;&gt;&gt; from pathlib import Path</span>
<span class="sd">    &gt;&gt;&gt; rec_config = Path(&quot;test_data/Server_structure/Calibrations/220922/recording_config_220922.yaml&quot;)</span>
<span class="sd">    &gt;&gt;&gt; calibration_validation_object = CalibrationValidation(</span>
<span class="sd">        ... project_config_filepath=&quot;test_data/project_config.yaml&quot;,</span>
<span class="sd">        ... directory=rec_config.parent, recording_config_filepath=rec_config,</span>
<span class="sd">        ... test_mode = False, output_directory=rec_config.parent)</span>
<span class="sd">    &gt;&gt;&gt; calibration_validation_object.add_ground_truth_config(&quot;test_data/ground_truth_config.yaml&quot;)</span>
<span class="sd">    &gt;&gt;&gt; calibration_validation_object.get_marker_predictions()</span>
<span class="sd">    &gt;&gt;&gt; calibration_validation_object.run_triangulation(</span>
<span class="sd">        ... calibration_toml_filepath=&quot;test_data/Server_structure/Calibrations/220922/220922_0_Bottom_Ground1_Ground2_Side1_Side2_Side3.toml&quot;,</span>
<span class="sd">        ... test_mode = False)</span>
<span class="sd">    &gt;&gt;&gt; mean_dist_err_percentage, mean_angle_err, reprojerr_nonan_mean = calibration_validation_object.evaluate_triangulation_of_calibration_validation_markers()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_metadata_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;recording_date&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_videometadata_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;calvin&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_allowed_filetypes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.AVI&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">,</span> <span class="s2">&quot;.mp4&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CalibrationValidation.add_ground_truth_config"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.CalibrationValidation.add_ground_truth_config">[docs]</a>    <span class="k">def</span> <span class="nf">add_ground_truth_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth_config_filepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the metadata from ground_truth_config_filepath and create list of</span>
<span class="sd">        markers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ground_truth_config_filepath: str or Path</span>
<span class="sd">            The path to the ground_truth config file.</span>

<span class="sd">        Notes</span>
<span class="sd">        _____</span>
<span class="sd">        The ground_truth yaml file at ground_truth_config_filepath has to have</span>
<span class="sd">        the following structure:</span>
<span class="sd">            distances: {str: {str: float}}</span>
<span class="sd">                Dictionary with first markers as key and dictionaries as values,</span>
<span class="sd">                that have second markers as key and the known distances between</span>
<span class="sd">                first and second markers as values.</span>
<span class="sd">                Distances are floats in cm.</span>
<span class="sd">            angles:</span>
<span class="sd">                Dictionary with vertex markers as keys and dictionaries as values,</span>
<span class="sd">                that have the following keys:</span>
<span class="sd">                    value: float</span>
<span class="sd">                        The value of the calculated angle in degrees.</span>
<span class="sd">                    marker: list of str</span>
<span class="sd">                        The markers between that draw the triangle (if 3 markers</span>
<span class="sd">                        given: 0: vertex, 1/2: ray) or a plane and a line (if 5</span>
<span class="sd">                        markers given: 1/2/3: plane, 4/5: line).</span>
<span class="sd">            unique_ids: list of str</span>
<span class="sd">                A list with all marker_ids to take into account for ground_truth</span>
<span class="sd">                validation and plotting.</span>
<span class="sd">            marker_ids_to_connect_in_3D_plot: list of list of str, optional</span>
<span class="sd">                Each element consists of a list of markers, that will be</span>
<span class="sd">                connected in the 3D calibration validation plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ground_truth_config_filepath</span> <span class="o">=</span> <span class="n">convert_to_path</span><span class="p">(</span><span class="n">ground_truth_config_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">ground_truth_config_filepath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span><span class="p">[</span><span class="s2">&quot;unique_ids&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="CalibrationValidation.get_marker_predictions"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.CalibrationValidation.get_marker_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">get_marker_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run marker detection for all images in metadata_from_videos.</span>

<span class="sd">        Save predictions in triangulation_dlc_cams_filepaths, validate</span>
<span class="sd">        predictions and create predictions plots.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_mode: bool, default False</span>
<span class="sd">            If True (default False), then pre-existing files won&#39;t be overwritten</span>
<span class="sd">            during the analysis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers_excluded_manually</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cam</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_videos</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">h5_output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_marker_detection</span><span class="p">(</span><span class="n">cam</span><span class="o">=</span><span class="n">cam</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="n">test_mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangulation_dlc_cams_filepaths</span><span class="p">[</span><span class="n">cam</span><span class="o">.</span><span class="n">cam_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5_output_filepath</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_triangulation_marker_ids</span><span class="p">(</span>
                <span class="n">triangulation_markers_df_filepath</span><span class="o">=</span><span class="n">h5_output_filepath</span><span class="p">,</span>
                <span class="n">framenum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">defined_marker_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">markers</span>
            <span class="p">)</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">PredictionsPlot</span><span class="p">(</span>
                <span class="n">image</span><span class="o">=</span><span class="n">cam</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="n">h5_output_filepath</span><span class="p">,</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">cam_id</span><span class="o">=</span><span class="n">cam</span><span class="o">.</span><span class="n">cam_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalibrationValidation.evaluate_triangulation_of_calibration_validation_markers"><a class="viewcode-back" href="../../core.html#core.triangulation_calibration_module.CalibrationValidation.evaluate_triangulation_of_calibration_validation_markers">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_triangulation_of_calibration_validation_markers</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">show_3D_plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the triangulated data and return mean errors.</span>

<span class="sd">        Calculate the distances and angles for all references in ground truth</span>
<span class="sd">        and get the differences between triangulated and ground truth data.</span>
<span class="sd">        Print these differences and show the plot of the triangulated data.</span>
<span class="sd">        Calculate the mean of distance and angle error and reprojection error.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_3D_plot: bool, default True</span>
<span class="sd">            If True (default), then a plot of the triangulated</span>
<span class="sd">            calibration_validation data is shown.</span>
<span class="sd">        verbose: bool, default True</span>
<span class="sd">            If True (default), then all angles and distances compared to their ground truth</span>
<span class="sd">            will be printed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mean_dist_err_percentage: np.float64</span>
<span class="sd">            The mean error of all triangulated distances compared to their</span>
<span class="sd">            ground truth.</span>
<span class="sd">        mean_angle_err: np.float64</span>
<span class="sd">            The mean error of all triangulated errors compared to their ground</span>
<span class="sd">            truth.</span>
<span class="sd">        reprojerr_nonan_mean: np.float64</span>
<span class="sd">            The mean reprojection error of all triangulated points.</span>

<span class="sd">        Notes</span>
<span class="sd">        _____</span>
<span class="sd">        The path directing to the ground_truth yaml file, that is saved as</span>
<span class="sd">        self.ground_truth_config, has to have the following structure:</span>
<span class="sd">            distances: {str: {str: float}}</span>
<span class="sd">                Dictionary with first markers as key and dictionaries as values,</span>
<span class="sd">                that have second markers as key and the known distances between</span>
<span class="sd">                first and second markers as values.</span>
<span class="sd">                Distances are floats in cm.</span>
<span class="sd">            angles:</span>
<span class="sd">                Dictionary with vertex markers as keys and dictionaries as values,</span>
<span class="sd">                that have the following keys:</span>
<span class="sd">                    value: float</span>
<span class="sd">                        The value of the calculated angle in degrees.</span>
<span class="sd">                    marker: list of str</span>
<span class="sd">                        The markers between that draw the triangle (if 3 markers</span>
<span class="sd">                        given: 0: vertex, 1/2: ray) or a plane and a line (if 5</span>
<span class="sd">                        markers given: 1/2/3: plane, 4/5: line).</span>
<span class="sd">            unique_ids: list of str</span>
<span class="sd">                A list with all marker_ids to take into account for ground_truth</span>
<span class="sd">                validation and plotting.</span>
<span class="sd">            marker_ids_to_connect_in_3D_plot: list of list of str, optional</span>
<span class="sd">                Each element consists of a list of markers, that will be</span>
<span class="sd">                connected in the 3D calibration validation plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span> <span class="o">=</span> <span class="n">add_reprojection_errors_of_all_calibration_validation_markers</span><span class="p">(</span>
            <span class="n">anipose_io</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">,</span> <span class="n">df_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span> <span class="o">=</span> <span class="n">set_distances_and_angles_for_evaluation</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span><span class="p">,</span>
                                                                  <span class="n">anipose_io</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">,</span>
                                                                  <span class="n">df_xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="n">gt_distances</span> <span class="o">=</span> <span class="n">load_distances_from_ground_truth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span> <span class="o">=</span> <span class="n">add_errors_between_computed_and_ground_truth_distances_for_different_references</span><span class="p">(</span>
            <span class="n">anipose_io</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">,</span> <span class="n">ground_truth_distances</span><span class="o">=</span><span class="n">gt_distances</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span> <span class="o">=</span> <span class="n">add_errors_between_computed_and_ground_truth_angles</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">reference_distance_id</span><span class="p">,</span> <span class="n">distance_errors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span>
                <span class="s2">&quot;distance_errors_in_cm&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Using </span><span class="si">{</span><span class="n">reference_distance_id</span><span class="si">}</span><span class="s1"> as reference distance, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;the mean distance error is: </span><span class="si">{</span><span class="n">distance_errors</span><span class="p">[</span><span class="s2">&quot;mean_error&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> cm.&#39;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">angle</span><span class="p">,</span> <span class="n">angle_error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span>
                <span class="s2">&quot;angles_error_ground_truth_vs_triangulated&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Considering </span><span class="si">{</span><span class="n">angle</span><span class="si">}</span><span class="s2">, the angle error is: </span><span class="si">{</span><span class="n">angle_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">show_3D_plot</span><span class="p">:</span>
            <span class="n">calibration_validation_plot</span> <span class="o">=</span> <span class="n">CalibrationValidationPlot</span><span class="p">(</span>
                <span class="n">p3d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;p3ds&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">bodyparts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;bodyparts&quot;</span><span class="p">],</span>
                <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">marker_ids_to_connect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_config</span><span class="p">[</span><span class="s2">&quot;marker_ids_to_connect_in_3D_plot&quot;</span><span class="p">],</span>
                <span class="n">filename_tag</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_output_filepath</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">calibration_validation_plot</span><span class="o">.</span><span class="n">create_plot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">all_percentage_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reference</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;distance_errors_in_cm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">all_percentage_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">percentage_error</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">percentage_error</span>
                                     <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;distance_errors_in_cm&quot;</span><span class="p">][</span><span class="n">reference</span><span class="p">][</span><span class="s2">&quot;individual_errors&quot;</span><span class="p">]]</span>
        <span class="n">all_angle_errors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;angles_error_ground_truth_vs_triangulated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">mean_dist_err_percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_percentage_errors</span><span class="p">))</span>
        <span class="n">mean_angle_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">all_angle_errors</span><span class="p">))</span>
        <span class="n">reprojerr_nonan_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anipose_io</span><span class="p">[</span><span class="s2">&quot;reproj_nonan&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">mean_dist_err_percentage</span><span class="p">,</span> <span class="n">mean_angle_err</span><span class="p">,</span> <span class="n">reprojerr_nonan_mean</span></div>

    <span class="k">def</span> <span class="nf">_create_csv_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">filepath_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calvin_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">score_threshold</span><span class="si">}</span><span class="s2">p_excludedmarkers&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">markers_excluded_manually</span><span class="si">}</span><span class="s2">_filteredFalse_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">triangulation_type</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath_out</span>

    <span class="k">def</span> <span class="nf">_run_marker_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam</span><span class="p">:</span> <span class="n">VideoMetadata</span><span class="p">,</span> <span class="n">test_mode</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">h5_output_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calvin_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">recording_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cam</span><span class="o">.</span><span class="n">cam_id</span><span class="si">}</span><span class="s2">.h5&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_mode</span> <span class="ow">or</span> <span class="p">(</span><span class="n">test_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">h5_output_filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration_evaluation_type</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration_evaluation_filepath</span>
                <span class="n">manual_interface</span> <span class="o">=</span> <span class="n">ManualAnnotation</span><span class="p">(</span>
                    <span class="n">object_to_analyse</span><span class="o">=</span><span class="n">cam</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
                    <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">marker_detection_directory</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">h5_output_filepath</span> <span class="o">=</span> <span class="n">manual_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">h5_output_filepath</span><span class="p">,</span>
                                                                      <span class="n">only_first_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration_evaluation_type</span> <span class="o">==</span> <span class="s2">&quot;DLC&quot;</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">calibration_evaluation_filepath</span>
                <span class="n">dlc_interface</span> <span class="o">=</span> <span class="n">DeeplabcutInterface</span><span class="p">(</span>
                    <span class="n">object_to_analyse</span><span class="o">=</span><span class="n">cam</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span>
                    <span class="n">output_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">marker_detection_directory</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">h5_output_filepath</span> <span class="o">=</span> <span class="n">dlc_interface</span><span class="o">.</span><span class="n">analyze_objects</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">h5_output_filepath</span><span class="p">,</span>
                                                                   <span class="n">filtering</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># filtering is not supported and not necessary for single frame predictions!</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;For calibration_evaluation only manual and DLC are supported!&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">h5_output_filepath</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Konstantin Kobel, Dennis Segebarth, Michael Schellenberger.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>